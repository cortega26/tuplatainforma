---
import type { CollectionEntry } from "astro:content";
import { getCanonicalPathFromSlug } from "@/domain/content/path";
import { toArticleView } from "@/utils/articleView";
import Datetime from "./Datetime.astro";
import ArticlePlaceholder from "./ArticlePlaceholder.astro";

interface Props {
  currentSlug: string;
  currentTags: string[];
  allPosts: CollectionEntry<"blog">[];
}

const { currentSlug, currentTags, allPosts } = Astro.props as Props;
const normalizedCurrentTags = currentTags.map(tag => tag.toLowerCase());

const normalizedPosts = allPosts.map(post => ({
  post,
  article: toArticleView(post),
}));

const candidatePosts = normalizedPosts.filter(
  ({ article }) => article.slug !== currentSlug && !article.draft
);

const scoredPosts = candidatePosts.map(item => {
  const score = item.article.tags.filter(tag =>
    normalizedCurrentTags.includes(tag.toLowerCase())
  ).length;

  return { ...item, score };
});

type RelatedItem = {
  post: CollectionEntry<"blog">;
  article: ReturnType<typeof toArticleView>;
  score: number;
};

const sortByScoreAndDate = (
  a: RelatedItem,
  b: RelatedItem
) =>
  b.score - a.score || b.article.pubDate.getTime() - a.article.pubDate.getTime();

const tagMatchedPosts = scoredPosts
  .filter(item => item.score > 0)
  .sort(sortByScoreAndDate);

const fallbackPosts = scoredPosts
  .filter(item => item.score === 0)
  .sort((a, b) => b.article.pubDate.getTime() - a.article.pubDate.getTime());

const relatedPosts = [...tagMatchedPosts, ...fallbackPosts].slice(0, 3);
---

{
  relatedPosts.length > 0 && (
    <section
      class="mt-10 border-t border-border px-4 pt-8 sm:px-6"
      style="background: linear-gradient(to bottom, color-mix(in srgb, var(--color-surface) 70%, transparent) 0%, transparent 24%);"
    >
      <h2
        class="mb-5 text-2xl font-bold sm:text-3xl"
        style="font-family: var(--font-display);"
      >
        Tambi√©n puede interesarte
      </h2>

      <ul class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        {relatedPosts.map(({ post, article }) => {
          const imageSrc =
            typeof post.data.ogImage === "string"
              ? post.data.ogImage
              : post.data.ogImage?.src;

          return (
            <li class="rounded-xl border border-border p-3">
              <a
                href={getCanonicalPathFromSlug(article.slug)}
                class="group block"
              >
                <div class="mb-3 overflow-hidden rounded-lg">
                  {imageSrc ? (
                    <img
                      src={imageSrc}
                      alt={`Portada de ${post.data.title}`}
                      width="1200"
                      height="675"
                      class="aspect-video w-full object-cover"
                      loading="lazy"
                      decoding="async"
                    />
                  ) : (
                    <ArticlePlaceholder tag={article.tags?.[0]} />
                  )}
                </div>

                <h3
                  class="mb-2 text-base leading-snug font-semibold transition-colors group-hover:text-accent"
                  style="font-family: var(--font-display);"
                >
                  {article.title}
                </h3>

                <Datetime
                  pubDatetime={article.pubDate}
                  modDatetime={article.updatedDate}
                  timezone={post.data.timezone}
                  size="sm"
                />
              </a>
            </li>
          );
        })}
      </ul>
    </section>
  )
}
