---
/**
 * Breadcrumbs robustos para deploy bajo subpath (GitHub Pages) sin duplicar base.
 * - No usa BASE/RAW_BASE.
 * - Stripea el basePath de Astro.site para el cálculo de segmentos.
 * - Construye hrefs acumulados correctos (no por segmento suelto).
 * - Labels (display) separados del href real.
 *
 * Nota TS: Astro.site es URL | undefined. Usamos fallback seguro para evitar error de tipos.
 */
import { getPath } from "@/utils/getPath";

const SITE_URL = Astro.site ?? new URL("http://localhost");

// Remove trailing slash from pathname (except keep "/" as "/")
const currentUrlPath = Astro.url.pathname.replace(/\/+$/, "") || "/";

// basePath: "/tuplatainforma" (GH Pages) o "" / "/" según entorno
const basePath = SITE_URL.pathname.replace(/\/+$/, "");

// Remove basePath from pathname to get the "site-local" path
const normalizedPath =
  basePath && currentUrlPath.startsWith(basePath)
    ? currentUrlPath.slice(basePath.length) || "/"
    : currentUrlPath;

// Segments without base (e.g. "/tags/afp/2" -> ["tags","afp","2"])
const segments = normalizedPath.split("/").filter(Boolean);

// Crumbs with cumulative hrefs (WITHOUT leading slash so new URL resolves relative to SITE_URL)
const crumbs = segments.map((seg, i) => ({
  seg,
  href: segments.slice(0, i + 1).join("/") + "/",
}));

const routeLabels: Record<string, string> = {
  about: "Nosotros",
  archives: "Archivo",
  calculadoras: "Calculadoras",
  posts: "Artículos",
  search: "Buscar",
  tags: "Etiquetas",
};

// Labels only for display (do not use for href building)
const labels = crumbs.map(c => {
  const decoded = decodeURIComponent(c.seg);
  const mapped = routeLabels[decoded];
  return mapped ? mapped : decoded.replace(/-/g, " ");
});

// Display tweaks
if (segments[0] === "posts") {
  const page = Number(segments[1]);
  if (!Number.isNaN(page)) labels.splice(0, 2, `Artículos (página ${page})`);
  else labels.splice(0, 1, "Artículos");
}

if (segments[0] === "tags" && !isNaN(Number(segments[2]))) {
  const page = Number(segments[2]);
  labels.splice(
    1,
    3,
    `${segments[1]} ${page === 1 ? "" : `(página ${segments[2]})`}`.trim()
  );
}
---

<nav class="app-layout mt-8 mb-1" aria-label="Migas de pan">
  <ul
    class="font-light [&>li]:inline [&>li:not(:last-child)>a]:hover:opacity-100"
  >
    <li>
      <a href={getPath("/")} class="opacity-80">Inicio</a>
      {
        crumbs.length > 0 ? (
          <span aria-hidden="true" class="opacity-80">
            &raquo;
          </span>
        ) : null
      }
    </li>

    {
      crumbs.map((crumb, index) =>
        index + 1 === crumbs.length ? (
          <li>
            <span
              class:list={["capitalize opacity-75", { lowercase: index > 0 }]}
              aria-current="page"
            >
              {labels[index]}
            </span>
          </li>
        ) : (
          <li>
            <a href={getPath(crumb.href)} class="capitalize opacity-70">
              {labels[index]}
            </a>
            <span aria-hidden="true">&raquo;</span>
          </li>
        )
      )
    }
  </ul>
</nav>
