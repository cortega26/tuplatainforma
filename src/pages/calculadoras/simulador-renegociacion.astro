---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";
import { getPath } from "@/utils/getPath";

const renegociacionGuidePath = getPath("/posts/renegociacion-superir/");
const { parameters: economicParameters } = await getEconomicParameters();
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
---

<Layout
  title="Simulador de Renegociaci√≥n de Deudas | Superir"
  description="Eval√∫a si podr√≠as calificar para renegociaci√≥n y estima una cuota posible seg√∫n deudas e ingresos."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        ‚öñÔ∏è Simulador de Renegociaci√≥n Superir
      </h1>
      <p class="max-w-xl text-foreground/70">
        Ingresa tus deudas e ingresos y estima si calificas para la
        renegociaci√≥n gratuita y qu√© cuota podr√≠as pagar.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Tus deudas e ingresos</h2>

        <div class="mb-5">
          <p class="mb-3 text-sm font-medium text-foreground/70">
            Deudas vencidas (con mora +90 d√≠as)
          </p>
          <div id="deudas-container" class="space-y-3">
            <div class="deuda-row flex items-center gap-2">
              <input
                type="number"
                placeholder="Monto ($) Ej: 1.500.000"
                min="0"
                class="deuda-monto flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none"
              />
              <input
                type="number"
                placeholder="Meses mora"
                min="1"
                max="240"
                value="90"
                class="deuda-dias w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none"
              />
            </div>
            <div class="deuda-row flex items-center gap-2">
              <input
                type="number"
                placeholder="Monto ($) Ej: 800.000"
                min="0"
                class="deuda-monto flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none"
              />
              <input
                type="number"
                placeholder="Meses mora"
                min="1"
                max="240"
                value="90"
                class="deuda-dias w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none"
              />
            </div>
          </div>
          <button
            id="agregar-deuda"
            class="mt-2 text-xs text-accent hover:underline"
            >+ Agregar otra deuda</button
          >
          <p class="mt-1 text-xs text-foreground/50">
            Meses mora = tiempo desde el √∫ltimo pago. Necesitas ‚â• 3 meses en
            cada deuda.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="ingreso"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Ingreso mensual neto ($)
          </label>
          <input
            type="number"
            id="ingreso"
            placeholder="Ej: 900.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Lo que recibes en tu cuenta (l√≠quido).
          </p>
        </div>

        <div class="mb-4">
          <label
            for="plazo-renego"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Plazo de renegociaci√≥n deseado (meses)
          </label>
          <input
            type="number"
            id="plazo-renego"
            placeholder="Ej: 36"
            min="6"
            max="120"
            value="36"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="tasa-renego"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Tasa de inter√©s del acuerdo (% mensual)
          </label>
          <input
            type="number"
            id="tasa-renego"
            placeholder="Ej: 1.5"
            min="0"
            max="5"
            step="0.1"
            value="1.5"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            La tasa var√≠a seg√∫n el acuerdo. Los acuerdos Superir suelen bajar la
            tasa respecto al contrato original. Usa 0% para simular cuota sin
            inter√©s.
          </p>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Simular renegociaci√≥n ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üìä Diagn√≥stico y simulaci√≥n</h2>
        <div
          id="resultado-contenido"
          data-guide-url={renegociacionGuidePath}
          data-uf={String(economicParameters.uf)}
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">‚öñÔ∏è</p>
          <p class="text-sm">
            Ingresa tus deudas e ingresos para ver si calificas.
          </p>
        </div>
        <p class="mt-3 text-xs text-foreground/40">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øQu√© es la renegociaci√≥n Superir?</h2>
      <p>
        La <strong
          >Superintendencia de Insolvencia y Reemprendimiento (Superir)</strong
        > ofrece un procedimiento gratuito donde act√∫a como mediadora entre t√∫ y tus
        acreedores para acordar nuevas condiciones de pago. No necesitas abogado y
        m√°s del 93% de quienes lo intentan llegan a acuerdo.
      </p>
      <ul>
        <li>
          <strong>Requisito clave:</strong> 2 o m√°s deudas vencidas hace m√°s de 90
          d√≠as corridos que sumen m√°s de 80 UF en total.
        </li>
        <li>
          <strong>Resultado posible:</strong> cuota m√°s baja, plazo m√°s largo, tasa
          menor, meses de gracia o condonaci√≥n de intereses.
        </li>
        <li>
          <strong>No aplica a:</strong> contribuyentes de primera categor√≠a (empresas
          con actividad comercial) en los √∫ltimos 24 meses.
        </li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Esta simulaci√≥n es educativa. Las condiciones reales del acuerdo
        dependen de la negociaci√≥n con los acreedores. Para iniciar el tr√°mite
        visita <a href="https://www.superir.gob.cl" target="_blank"
          >superir.gob.cl</a
        >.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { simulateDebtRenegotiation } from "@/application/use-cases/SimulateDebtRenegotiation";

  function fmt(n: number) {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtUF(n: number) {
    return n.toFixed(2) + " UF";
  }

  function buildRow(
    label: string,
    value: string,
    colorClass = ""
  ): HTMLDivElement {
    const line = document.createElement("div");
    line.className =
      "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

    const labelElement = document.createElement("span");
    labelElement.className = "text-foreground/60";
    labelElement.textContent = label;

    const valueElement = document.createElement("span");
    valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
    valueElement.textContent = value;

    line.append(labelElement, valueElement);
    return line;
  }

  function buildChecklistLine(
    isValid: boolean,
    text: string
  ): HTMLParagraphElement {
    const line = document.createElement("p");
    line.textContent = `${isValid ? "‚úì" : "‚úó"} ${text}`;
    line.className = isValid ? "text-green-500" : "text-red-400";
    return line;
  }

  function createDebtRow(): HTMLDivElement {
    const row = document.createElement("div");
    row.className = "deuda-row flex items-center gap-2";

    const amountInput = document.createElement("input");
    amountInput.type = "number";
    amountInput.placeholder = "Monto ($)";
    amountInput.min = "0";
    amountInput.className =
      "deuda-monto flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none";

    const overdueInput = document.createElement("input");
    overdueInput.type = "number";
    overdueInput.placeholder = "Meses mora";
    overdueInput.min = "1";
    overdueInput.max = "240";
    overdueInput.value = "90";
    overdueInput.className =
      "deuda-dias w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none";

    const removeButton = document.createElement("button");
    removeButton.type = "button";
    removeButton.textContent = "√ó";
    removeButton.className =
      "eliminar-deuda text-lg leading-none text-foreground/40 hover:text-red-400";
    removeButton.addEventListener("click", () => row.remove());

    row.append(amountInput, overdueInput, removeButton);
    return row;
  }

  // Agregar deuda
  document.getElementById("agregar-deuda")?.addEventListener("click", () => {
    const container = document.getElementById("deudas-container")!;
    container.appendChild(createDebtRow());
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const resultContainer = document.getElementById("resultado-contenido");
    const guideUrl = resultContainer?.dataset?.guideUrl;
    const ufValue = Number(resultContainer?.dataset?.uf);
    if (!guideUrl || !Number.isFinite(ufValue) || ufValue <= 0) return;

    const filas = document.querySelectorAll(".deuda-row");
    const deudas: { monto: number; meses: number }[] = [];

    filas.forEach(fila => {
      const monto =
        parseFloat(
          (fila.querySelector(".deuda-monto") as HTMLInputElement).value
        ) || 0;
      const meses =
        parseInt(
          (fila.querySelector(".deuda-dias") as HTMLInputElement).value
        ) || 0;
      if (monto > 0) deudas.push({ monto, meses });
    });

    const ingreso =
      parseFloat(
        (document.getElementById("ingreso") as HTMLInputElement).value
      ) || 0;
    const plazo =
      parseInt(
        (document.getElementById("plazo-renego") as HTMLInputElement).value
      ) || 36;
    const tasaMensual =
      parseFloat(
        (document.getElementById("tasa-renego") as HTMLInputElement).value
      ) / 100;

    if (deudas.length === 0 || ingreso <= 0) {
      alert("Por favor ingresa al menos una deuda y tu ingreso mensual.");
      return;
    }

    let simulacion;
    try {
      simulacion = simulateDebtRenegotiation({
        debts: deudas.map(deuda => ({
          amount: deuda.monto,
          overdueMonths: deuda.meses,
        })),
        monthlyIncome: ingreso,
        termMonths: plazo,
        monthlyRatePercent: tasaMensual * 100,
        ufValue,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo simular la renegociaci√≥n."
      );
      return;
    }

    const container = document.getElementById("resultado-contenido")!;

    const statusBox = document.createElement("div");
    statusBox.className = `mb-5 rounded-lg border p-4 ${
      simulacion.qualifies
        ? "border-green-500/30 bg-green-500/5"
        : "border-red-500/30 bg-red-500/10"
    }`;

    const statusTitle = document.createElement("p");
    statusTitle.className = `mb-3 text-base font-bold ${
      simulacion.qualifies ? "text-green-500" : "text-red-400"
    }`;
    statusTitle.textContent = simulacion.qualifies
      ? "‚úì Probablemente calificas para renegociar"
      : "‚ö†Ô∏è Posibles problemas para calificar";

    const checklist = document.createElement("div");
    checklist.className = "space-y-1.5 text-sm";
    checklist.append(
      buildChecklistLine(
        simulacion.requirementChecks.hasTwoOrMoreDebts,
        `2 o m√°s deudas distintas: ${deudas.length} ingresada${deudas.length > 1 ? "s" : ""}`
      ),
      buildChecklistLine(
        simulacion.requirementChecks.hasTwoOrMoreQualifiedDebts,
        `Con +90 d√≠as de mora: ${simulacion.qualifiedDebtCount} califican`
      ),
      buildChecklistLine(
        simulacion.requirementChecks.reachesMinimumUf,
        `Total supera ${simulacion.minimumDebtUf} UF: ${fmtUF(simulacion.qualifiedDebtUf)} (m√≠n. ${simulacion.minimumDebtUf} UF = ${fmt(simulacion.minimumDebtUf * ufValue)})`
      )
    );
    statusBox.append(statusTitle, checklist);

    const burdenColorClass =
      simulacion.incomeBurdenPercent <= 30
        ? "text-green-500"
        : simulacion.incomeBurdenPercent <= 50
          ? "text-yellow-500"
          : "text-red-400";

    const simulationSection = document.createElement("div");
    simulationSection.className = "mt-5";
    const simulationLabel = document.createElement("p");
    simulationLabel.className =
      "mb-2 text-xs font-bold text-foreground/50 uppercase";
    simulationLabel.textContent = `Simulaci√≥n de acuerdo ‚Äî ${plazo} meses`;
    simulationSection.append(
      simulationLabel,
      buildRow(
        "Cuota mensual estimada",
        fmt(simulacion.monthlyPayment),
        burdenColorClass
      ),
      buildRow(
        "Como % de tu ingreso",
        `${simulacion.incomeBurdenPercent.toFixed(1)}%`,
        burdenColorClass
      ),
      buildRow("Total a pagar", fmt(simulacion.totalPaid)),
      buildRow("Intereses del acuerdo", fmt(simulacion.totalInterest))
    );

    const advisory = document.createElement("div");
    advisory.className =
      "mt-3 rounded-lg bg-foreground/5 p-3 text-xs text-foreground/60";
    advisory.textContent =
      simulacion.incomeBurdenPercent <= 30
        ? "‚úÖ La cuota simulada es manejable (‚â§30% de tu ingreso). Una propuesta en este rango tiene m√°s chances de ser aceptada."
        : simulacion.incomeBurdenPercent <= 50
          ? "‚ö†Ô∏è La cuota es alta (30‚Äì50% del ingreso). Considera extender el plazo o negociar condonaci√≥n de intereses."
          : "üî¥ La cuota supera el 50% de tu ingreso. Ajusta el plazo o solicita en la Superir que medien una quita de capital.";

    const guideLink = document.createElement("a");
    guideLink.href = guideUrl;
    guideLink.className =
      "mt-4 block text-center text-xs text-accent hover:underline";
    guideLink.textContent = "‚Üí Leer gu√≠a completa de la renegociaci√≥n Superir";

    container.replaceChildren(
      statusBox,
      buildRow("Total deuda declarada", fmt(simulacion.totalDebtClp)),
      buildRow("En UF", fmtUF(simulacion.totalDebtUf)),
      simulationSection,
      advisory,
      guideLink
    );
  });
</script>
