---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        ‚öñÔ∏è Simulador de Renegociaci√≥n Superir
      </h1>
      <p class="max-w-xl text-foreground/70">
        Ingresa tus deudas e ingresos y estima si calificas para la renegociaci√≥n gratuita y qu√© cuota podr√≠as pagar.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Tus deudas e ingresos</h2>

        <div class="mb-5">
          <p class="text-sm font-medium text-foreground/70 mb-3">Deudas vencidas (con mora +90 d√≠as)</p>
          <div id="deudas-container" class="space-y-3">
            <div class="deuda-row flex gap-2 items-center">
              <input type="number" placeholder="Monto ($) Ej: 1.500.000" min="0"
                class="flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-monto" />
              <input type="number" placeholder="Meses mora" min="1" max="240" value="90"
                class="w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-dias" />
            </div>
            <div class="deuda-row flex gap-2 items-center">
              <input type="number" placeholder="Monto ($) Ej: 800.000" min="0"
                class="flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-monto" />
              <input type="number" placeholder="Meses mora" min="1" max="240" value="90"
                class="w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-dias" />
            </div>
          </div>
          <button id="agregar-deuda" class="mt-2 text-xs text-accent hover:underline">+ Agregar otra deuda</button>
          <p class="mt-1 text-xs text-foreground/50">Meses mora = tiempo desde el √∫ltimo pago. Necesitas ‚â• 3 meses en cada deuda.</p>
        </div>

        <div class="mb-4">
          <label for="ingreso" class="mb-1 block text-sm font-medium text-foreground/70">
            Ingreso mensual neto ($)
          </label>
          <input type="number" id="ingreso" placeholder="Ej: 900.000" min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none" />
          <p class="mt-1 text-xs text-foreground/50">Lo que recibes en tu cuenta (l√≠quido).</p>
        </div>

        <div class="mb-4">
          <label for="plazo-renego" class="mb-1 block text-sm font-medium text-foreground/70">
            Plazo de renegociaci√≥n deseado (meses)
          </label>
          <input type="number" id="plazo-renego" placeholder="Ej: 36" min="6" max="120" value="36"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none" />
        </div>

        <div class="mb-4">
          <label for="tasa-renego" class="mb-1 block text-sm font-medium text-foreground/70">
            Tasa de inter√©s del acuerdo (% mensual)
          </label>
          <input type="number" id="tasa-renego" placeholder="Ej: 1.5" min="0" max="5" step="0.1" value="1.5"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none" />
          <p class="mt-1 text-xs text-foreground/50">La tasa var√≠a seg√∫n el acuerdo. Los acuerdos Superir suelen bajar la tasa respecto al contrato original. Usa 0% para simular cuota sin inter√©s.</p>
        </div>

        <button id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90">
          Simular renegociaci√≥n ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üìä Diagn√≥stico y simulaci√≥n</h2>
        <div id="resultado-contenido" class="py-8 text-center text-foreground/40">
          <p class="mb-3 text-4xl">‚öñÔ∏è</p>
          <p class="text-sm">Ingresa tus deudas e ingresos para ver si calificas.</p>
        </div>
      </div>
    </section>

    <section class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert">
      <h2>¬øQu√© es la renegociaci√≥n Superir?</h2>
      <p>
        La <strong>Superintendencia de Insolvencia y Reemprendimiento (Superir)</strong> ofrece un procedimiento gratuito donde act√∫a como mediadora entre t√∫ y tus acreedores para acordar nuevas condiciones de pago. No necesitas abogado y m√°s del 93% de quienes lo intentan llegan a acuerdo.
      </p>
      <ul>
        <li><strong>Requisito clave:</strong> 2 o m√°s deudas vencidas hace m√°s de 90 d√≠as corridos que sumen m√°s de 80 UF en total.</li>
        <li><strong>Resultado posible:</strong> cuota m√°s baja, plazo m√°s largo, tasa menor, meses de gracia o condonaci√≥n de intereses.</li>
        <li><strong>No aplica a:</strong> contribuyentes de primera categor√≠a (empresas con actividad comercial) en los √∫ltimos 24 meses.</li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Esta simulaci√≥n es educativa. Las condiciones reales del acuerdo dependen de la negociaci√≥n con los acreedores. Para iniciar el tr√°mite visita <a href="https://www.superir.gob.cl" target="_blank">superir.gob.cl</a>.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  const UF_VALOR = 39773.62;
  const UF_MINIMO = 80;

  function fmt(n: number) {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtUF(n: number) {
    return n.toFixed(2) + " UF";
  }

  function row(label: string, value: string, color = "") {
    return `<div class="flex justify-between items-center py-2 border-b border-border text-sm last:border-0">
      <span class="text-foreground/60">${label}</span>
      <span class="font-semibold font-mono ${color}">${value}</span>
    </div>`;
  }

  function calcularCuota(monto: number, tasa: number, plazo: number) {
    if (tasa === 0) return monto / plazo;
    return (monto * tasa * Math.pow(1 + tasa, plazo)) / (Math.pow(1 + tasa, plazo) - 1);
  }

  // Agregar deuda
  document.getElementById("agregar-deuda")?.addEventListener("click", () => {
    const container = document.getElementById("deudas-container")!;
    const row = document.createElement("div");
    row.className = "deuda-row flex gap-2 items-center";
    row.innerHTML = `
      <input type="number" placeholder="Monto ($)" min="0"
        class="flex-1 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-monto" />
      <input type="number" placeholder="Meses mora" min="1" max="240" value="90"
        class="w-28 rounded-lg border border-border bg-background px-3 py-2 text-sm text-foreground focus:border-accent focus:outline-none deuda-dias" />
      <button class="eliminar-deuda text-foreground/40 hover:text-red-400 text-lg leading-none">√ó</button>
    `;
    container.appendChild(row);
    row.querySelector(".eliminar-deuda")?.addEventListener("click", () => row.remove());
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const filas = document.querySelectorAll(".deuda-row");
    const deudas: { monto: number; meses: number }[] = [];

    filas.forEach(fila => {
      const monto = parseFloat((fila.querySelector(".deuda-monto") as HTMLInputElement).value) || 0;
      const meses = parseInt((fila.querySelector(".deuda-dias") as HTMLInputElement).value) || 0;
      if (monto > 0) deudas.push({ monto, meses });
    });

    const ingreso = parseFloat((document.getElementById("ingreso") as HTMLInputElement).value) || 0;
    const plazo = parseInt((document.getElementById("plazo-renego") as HTMLInputElement).value) || 36;
    const tasaMensual = parseFloat((document.getElementById("tasa-renego") as HTMLInputElement).value) / 100;

    if (deudas.length === 0 || ingreso <= 0) {
      alert("Por favor ingresa al menos una deuda y tu ingreso mensual.");
      return;
    }

    const totalDeuda = deudas.reduce((a, b) => a + b.monto, 0);
    const totalUF = totalDeuda / UF_VALOR;
    const deudasCalificadas = deudas.filter(d => d.meses >= 3);
    const totalUFCalificado = deudasCalificadas.reduce((a, b) => a + b.monto, 0) / UF_VALOR;

    // Verificar requisitos
    const req1 = deudas.length >= 2;
    const req2 = deudasCalificadas.length >= 2;
    const req3 = totalUFCalificado >= UF_MINIMO;

    const check = (ok: boolean) => ok
      ? '<span class="text-green-500 font-bold">‚úì</span>'
      : '<span class="text-red-400 font-bold">‚úó</span>';

    // Simulaci√≥n de cuota
    const cuotaSimulada = calcularCuota(totalDeuda, tasaMensual, plazo);
    const totalPagado = cuotaSimulada * plazo;
    const totalIntereses = totalPagado - totalDeuda;
    const pctIngreso = (cuotaSimulada / ingreso) * 100;

    const califica = req1 && req2 && req3;

    const html = `
      <div class="mb-5 rounded-lg border ${califica ? "border-green-500/30 bg-green-500/5" : "border-red-500/30 bg-red-500/10"} p-4">
        <p class="font-bold ${califica ? "text-green-500" : "text-red-400"} text-base mb-3">
          ${califica ? "‚úì Probablemente calificas para renegociar" : "‚ö†Ô∏è Posibles problemas para calificar"}
        </p>
        <div class="space-y-1.5 text-sm">
          <p>${check(req1)} 2 o m√°s deudas distintas: ${deudas.length} ingresada${deudas.length > 1 ? "s" : ""}</p>
          <p>${check(req2)} Con +90 d√≠as de mora: ${deudasCalificadas.length} califican</p>
          <p>${check(req3)} Total supera 80 UF: ${fmtUF(totalUFCalificado)} (m√≠n. 80 UF = ${fmt(UF_MINIMO * UF_VALOR)})</p>
        </div>
      </div>

      ${row("Total deuda declarada", fmt(totalDeuda))}
      ${row("En UF", fmtUF(totalUF))}

      <div class="mt-5">
        <p class="text-xs font-bold text-foreground/50 uppercase mb-2">Simulaci√≥n de acuerdo ‚Äî ${plazo} meses</p>
        ${row("Cuota mensual estimada", fmt(cuotaSimulada), pctIngreso <= 30 ? "text-green-500" : pctIngreso <= 50 ? "text-yellow-500" : "text-red-400")}
        ${row("Como % de tu ingreso", pctIngreso.toFixed(1) + "%", pctIngreso <= 30 ? "text-green-500" : pctIngreso <= 50 ? "text-yellow-500" : "text-red-400")}
        ${row("Total a pagar", fmt(totalPagado))}
        ${row("Intereses del acuerdo", fmt(totalIntereses))}
      </div>

      <div class="mt-3 rounded-lg bg-foreground/5 p-3 text-xs text-foreground/60">
        ${pctIngreso <= 30
          ? "‚úÖ La cuota simulada es manejable (‚â§30% de tu ingreso). Una propuesta en este rango tiene m√°s chances de ser aceptada."
          : pctIngreso <= 50
          ? "‚ö†Ô∏è La cuota es alta (30‚Äì50% del ingreso). Considera extender el plazo o negociar condonaci√≥n de intereses."
          : "üî¥ La cuota supera el 50% de tu ingreso. Ajusta el plazo o solicita en la Superir que medien una quita de capital."}
      </div>

      <a href="${(import.meta.env.BASE_URL || "/").replace(/\/?$/, "/")}blog/renegociacion-superir/"
        class="mt-4 block text-center text-xs text-accent hover:underline">
        ‚Üí Leer gu√≠a completa de la renegociaci√≥n Superir
      </a>
    `;

    document.getElementById("resultado-contenido")!.innerHTML = html;
  });
</script>
