---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Calculadora de Prepago de Cr√©dito | Ahorro en Intereses"
  description="Estima cu√°nto ahorras en intereses al prepagar un cr√©dito y compara con invertir ese dinero."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üí° ¬øMe conviene prepagar el cr√©dito?
      </h1>
      <p class="max-w-xl text-foreground/70">
        Calcula cu√°nto ahorras en intereses si haces un abono extraordinario a
        tu cr√©dito y si conviene m√°s prepagar o invertir ese dinero.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Tu cr√©dito actual</h2>

        <div class="mb-4">
          <label
            for="saldo"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Saldo pendiente ($)
          </label>
          <input
            type="number"
            id="saldo"
            placeholder="Ej: 15.000.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="cuota"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Cuota mensual actual ($)
          </label>
          <input
            type="number"
            id="cuota"
            placeholder="Ej: 350.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="tasa-credito"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Tasa de inter√©s mensual (%)
          </label>
          <input
            type="number"
            id="tasa-credito"
            placeholder="Ej: 0.8"
            min="0"
            max="5"
            step="0.01"
            value="0.8"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Hipotecarios: ~0.4‚Äì0.8% mensual. Consumo: ~1.5‚Äì3.5% mensual.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="meses-restantes"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Meses restantes
          </label>
          <input
            type="number"
            id="meses-restantes"
            placeholder="Ej: 180"
            min="1"
            max="480"
            value="180"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="monto-prepago"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Monto del abono extraordinario ($)
          </label>
          <input
            type="number"
            id="monto-prepago"
            placeholder="Ej: 2.000.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-foreground/70"
            >Efecto del prepago</label
          >
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="efecto"
                value="reducir-plazo"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-xs font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Acortar plazo
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="efecto"
                value="reducir-cuota"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-xs font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Bajar cuota
              </span>
            </label>
          </div>
        </div>

        <div class="mb-4 border-t border-border pt-4">
          <label
            for="rentabilidad-alternativa"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Rentabilidad alternativa (% anual)
          </label>
          <select
            id="rentabilidad-alternativa"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          >
            <option value="3">3% ‚Äî DAP / Fondo E AFP</option>
            <option value="5" selected>5% ‚Äî Fondo mutuo conservador</option>
            <option value="7">7% ‚Äî Fondo mixto / APV</option>
            <option value="10">10% ‚Äî Renta variable (estimado hist√≥rico)</option
            >
          </select>
          <p class="mt-1 text-xs text-foreground/50">
            Para comparar: ¬øqu√© pasar√≠a si en vez de prepagar, invirtieras ese
            dinero?
          </p>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular ahorro ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üí∞ ¬øConviene prepagar?</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">üí°</p>
          <p class="text-sm">
            Ingresa los datos del cr√©dito y el monto a prepagar.
          </p>
        </div>
      </div>
    </section>

    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øCu√°ndo conviene prepagar y cu√°ndo no?</h2>
      <p>
        La regla b√°sica: <strong
          >si la tasa de tu cr√©dito es mayor a la rentabilidad que puedes
          obtener invirtiendo, conviene prepagar</strong
        >. Si es al rev√©s, puede ser mejor invertir.
      </p>
      <ul>
        <li>
          <strong>Cr√©dito de consumo (tasa alta ~3% mensual):</strong> Casi siempre
          conviene prepagar. Ninguna inversi√≥n segura renta m√°s que el 36‚Äì50% anual
          que cobran estas deudas.
        </li>
        <li>
          <strong>Cr√©dito hipotecario (tasa baja ~0.5% mensual):</strong> La decisi√≥n
          es m√°s pareja. Una inversi√≥n en fondos mutuos o ETF puede superar f√°cilmente
          ese costo anual de ~6%.
        </li>
        <li>
          <strong>Factor emocional:</strong> Quedar sin deudas tiene un valor que
          los n√∫meros no capturan. Si la deuda te genera estr√©s, eso tambi√©n importa.
        </li>
        <li>
          <strong>Comisi√≥n de prepago:</strong> Algunos cr√©ditos cobran hasta 1 mes
          de inter√©s por prepago anticipado. Verifica en tu contrato antes de decidir.
        </li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Simulaci√≥n educativa con supuestos simplificados. Las condiciones
        reales de tu cr√©dito pueden variar. Consulta tu contrato antes de hacer
        un prepago.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { simulateCreditPrepayment } from "@/application/use-cases/SimulateCreditPrepayment";

  function fmt(n: number) {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtM(n: number) {
    if (n >= 1_000_000) return "$" + (n / 1_000_000).toFixed(2) + " M";
    return fmt(n);
  }

  function buildRow(
    label: string,
    value: string,
    colorClass = ""
  ): HTMLDivElement {
    const line = document.createElement("div");
    line.className =
      "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

    const labelElement = document.createElement("span");
    labelElement.className = "text-foreground/60";
    labelElement.textContent = label;

    const valueElement = document.createElement("span");
    valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
    valueElement.textContent = value;

    line.append(labelElement, valueElement);
    return line;
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const saldo =
      parseFloat(
        (document.getElementById("saldo") as HTMLInputElement).value
      ) || 0;
    const cuota =
      parseFloat(
        (document.getElementById("cuota") as HTMLInputElement).value
      ) || 0;
    const tasa =
      parseFloat(
        (document.getElementById("tasa-credito") as HTMLInputElement).value
      ) / 100;
    const mesesRestantes =
      parseInt(
        (document.getElementById("meses-restantes") as HTMLInputElement).value
      ) || 0;
    const montoPrepago =
      parseFloat(
        (document.getElementById("monto-prepago") as HTMLInputElement).value
      ) || 0;
    const efecto = (
      document.querySelector("input[name='efecto']:checked") as HTMLInputElement
    )?.value;
    const rentAlternativa =
      parseFloat(
        (
          document.getElementById(
            "rentabilidad-alternativa"
          ) as HTMLSelectElement
        ).value
      ) / 100;

    if (saldo <= 0 || cuota <= 0 || montoPrepago <= 0) {
      alert("Por favor ingresa saldo, cuota y monto de prepago.");
      return;
    }

    let simulacion;
    try {
      simulacion = simulateCreditPrepayment({
        currentBalance: saldo,
        monthlyPayment: cuota,
        monthlyRatePercent: tasa * 100,
        remainingMonths: mesesRestantes,
        prepaymentAmount: montoPrepago,
        effect: efecto === "reducir-cuota" ? "reducir-cuota" : "reducir-plazo",
        alternativeAnnualReturnPercent: rentAlternativa * 100,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo simular el prepago."
      );
      return;
    }

    const container = document.getElementById("resultado-contenido")!;

    const verdict = document.createElement("div");
    verdict.className = `mb-5 rounded-lg border p-4 text-center ${
      simulacion.mathematicallyBetterToPrepay
        ? "border-green-500/30 bg-green-500/5"
        : "border-yellow-500/30 bg-yellow-500/5"
    }`;

    const verdictLabel = document.createElement("p");
    verdictLabel.className = `mb-1 text-xs font-bold tracking-widest uppercase ${
      simulacion.mathematicallyBetterToPrepay
        ? "text-green-500"
        : "text-yellow-500"
    }`;
    verdictLabel.textContent = simulacion.mathematicallyBetterToPrepay
      ? "‚úì Conviene prepagar"
      : "‚öñÔ∏è Puede convenir m√°s invertir";

    const verdictValue = document.createElement("p");
    verdictValue.className = "text-2xl font-bold";
    verdictValue.textContent = fmtM(simulacion.interestSavings);

    const verdictSub = document.createElement("p");
    verdictSub.className = "text-sm text-foreground/50";
    verdictSub.textContent = "ahorrados en intereses";
    verdict.append(verdictLabel, verdictValue, verdictSub);

    const withoutLabel = document.createElement("p");
    withoutLabel.className =
      "mb-2 text-xs font-bold text-foreground/50 uppercase";
    withoutLabel.textContent = "Sin prepago";

    const withLabel = document.createElement("p");
    withLabel.className =
      "mb-2 mt-4 text-xs font-bold text-foreground/50 uppercase";
    withLabel.textContent = `Con prepago de ${fmt(montoPrepago)}`;

    const investmentBox = document.createElement("div");
    investmentBox.className = "mt-5 rounded-lg bg-foreground/5 p-3";
    const investmentLabel = document.createElement("p");
    investmentLabel.className =
      "mb-2 text-xs font-bold text-foreground/50 uppercase";
    investmentLabel.textContent = `Alternativa: invertir ${fmt(montoPrepago)} al ${
      rentAlternativa * 100
    }% anual`;
    investmentBox.append(
      investmentLabel,
      buildRow(
        `Valor futuro (en ${simulacion.withoutPrepayment.months} meses)`,
        fmtM(simulacion.futureInvestmentValue)
      ),
      buildRow(
        "Ganancia estimada",
        fmtM(simulacion.investmentGain),
        simulacion.investmentGain > simulacion.interestSavings
          ? "text-green-500"
          : "text-foreground/60"
      ),
      buildRow(
        "vs ahorro por prepago",
        fmtM(simulacion.interestSavings),
        simulacion.interestSavings >= simulacion.investmentGain
          ? "text-green-500"
          : "text-foreground/60"
      )
    );

    const finalNote = document.createElement("p");
    finalNote.className = "mt-3 text-xs text-foreground/40";
    finalNote.textContent = simulacion.mathematicallyBetterToPrepay
      ? `Con tu tasa de ${simulacion.annualCreditRatePercent.toFixed(1)}% anual, el cr√©dito "renta" m√°s caro que la alternativa de inversi√≥n (${(
          rentAlternativa * 100
        ).toFixed(0)}% anual). Prepagar es la mejor opci√≥n matem√°tica.`
      : "La inversi√≥n podr√≠a generar m√°s que lo que ahorras en intereses. Pero ojo: la rentabilidad de la inversi√≥n no est√° garantizada.";

    const conditionalRow =
      efecto === "reducir-plazo"
        ? buildRow(
            "Meses que se acorta",
            simulacion.monthsSaved > 0
              ? `${simulacion.monthsSaved} meses menos`
              : "Se liquida",
            "text-green-500"
          )
        : buildRow(
            "Nueva cuota mensual",
            simulacion.newMonthlyPaymentIfReducePayment !== null
              ? fmt(simulacion.newMonthlyPaymentIfReducePayment)
              : "Saldado",
            "text-green-500"
          );

    container.replaceChildren(
      verdict,
      withoutLabel,
      buildRow(
        "Meses restantes",
        simulacion.withoutPrepayment.months.toString()
      ),
      buildRow(
        "Total intereses",
        fmt(simulacion.withoutPrepayment.totalInterest),
        "text-red-400"
      ),
      withLabel,
      conditionalRow,
      buildRow(
        "Total intereses con prepago",
        fmt(simulacion.withPrepayment.totalInterest),
        "text-green-500"
      ),
      buildRow(
        "Ahorro en intereses",
        fmt(simulacion.interestSavings),
        "text-green-500"
      ),
      investmentBox,
      finalNote
    );
  });
</script>
