---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Calculadora de Cr√©dito de Consumo | Cuota y CAE"
  description="Calcula cuota mensual, intereses totales y CAE de un cr√©dito de consumo y compara escenarios."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üè¶ Calculadora de Cr√©dito de Consumo
      </h1>
      <p class="max-w-xl text-secondary">
        Calcula la cuota mensual, el costo total, los intereses y el CAE de
        cualquier cr√©dito de consumo. Compara dos opciones lado a lado.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Datos del cr√©dito</h2>

        <div class="mb-4">
          <label
            for="monto"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Monto del cr√©dito ($)
          </label>
          <input
            type="number"
            id="monto"
            placeholder="Ej: 2.000.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="plazo"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Plazo (meses)
          </label>
          <input
            type="number"
            id="plazo"
            placeholder="Ej: 24"
            min="1"
            max="120"
            value="24"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="tasa-tipo"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Tipo de tasa
          </label>
          <div class="mb-2 flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="tasa-tipo"
                value="mensual"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Mensual
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="tasa-tipo"
                value="anual"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Anual
              </span>
            </label>
          </div>
          <input
            type="number"
            id="tasa"
            placeholder="Ej: 3.49"
            min="0"
            step="0.01"
            value="3.49"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            TMC para cr√©ditos hasta 200 UF: ~3.49% mensual (~51.5% anual).
            Verifica la tasa exacta de tu oferta.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="seguro"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Seguro mensual ($) ‚Äî opcional
          </label>
          <input
            type="number"
            id="seguro"
            placeholder="Ej: 5.000"
            min="0"
            value="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            Algunos cr√©ditos incluyen seguro de desgravamen. Si te lo ofrecen,
            ingresa el monto mensual.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="gastos"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Gastos notariales / operacionales ($) ‚Äî opcional
          </label>
          <input
            type="number"
            id="gastos"
            placeholder="Ej: 50.000"
            min="0"
            value="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular cr√©dito ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üìã Desglose del cr√©dito</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-muted"
        >
          <p class="mb-3 text-4xl">üè¶</p>
          <p class="text-sm">Ingresa los datos y presiona calcular.</p>
        </div>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øQu√© es el CAE y por qu√© importa?</h2>
      <p>
        El <strong>CAE (Carga Anual Equivalente)</strong> es el indicador que permite
        comparar el costo real de distintos cr√©ditos de forma justa. Incluye la tasa
        de inter√©s, los seguros y los gastos operacionales, expresados como porcentaje
        anual del monto solicitado.
      </p>
      <ul>
        <li>
          <strong>No te fijes solo en la cuota:</strong> Una cuota baja puede venir
          con un plazo largo que duplica el costo total.
        </li>
        <li>
          <strong>No te fijes solo en la tasa:</strong> Una tasa baja con seguros
          caros puede resultar en un CAE m√°s alto que un cr√©dito con tasa mayor sin
          seguros.
        </li>
        <li>
          <strong>Compara siempre el CAE:</strong> La ley obliga a todas las instituciones
          financieras en Chile a informarlo. Es el √∫nico n√∫mero que permite comparaci√≥n
          justa.
        </li>
      </ul>
      <p class="text-sm text-muted">
        ‚ö†Ô∏è El CAE calculado aqu√≠ es aproximado. El CAE oficial de un cr√©dito lo
        calcula la instituci√≥n financiera seg√∫n metodolog√≠a CMF. Para comparar
        ofertas reales usa <a
          href="https://www.comparaonline.cl"
          target="_blank">ComparaOnline</a
        > o solicita la hoja TCEA a tu banco.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { calculateConsumerCredit } from "@/application/use-cases/CalculateConsumerCredit";

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const monto =
      parseFloat(
        (document.getElementById("monto") as HTMLInputElement).value
      ) || 0;
    const plazo =
      parseInt((document.getElementById("plazo") as HTMLInputElement).value) ||
      0;
    const tasaRaw =
      parseFloat((document.getElementById("tasa") as HTMLInputElement).value) ||
      0;
    const tipoTasa = (
      document.querySelector(
        "input[name='tasa-tipo']:checked"
      ) as HTMLInputElement
    )?.value;
    const seguro =
      parseFloat(
        (document.getElementById("seguro") as HTMLInputElement).value
      ) || 0;
    const gastos =
      parseFloat(
        (document.getElementById("gastos") as HTMLInputElement).value
      ) || 0;

    if (monto <= 0 || plazo <= 0 || tasaRaw <= 0) {
      alert("Por favor ingresa monto, plazo y tasa.");
      return;
    }

    let resultado;
    try {
      resultado = calculateConsumerCredit({
        principal: monto,
        termMonths: plazo,
        rateValue: tasaRaw,
        rateType: tipoTasa === "anual" ? "anual" : "mensual",
        monthlyInsurance: seguro,
        operatingCosts: gastos,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo calcular el cr√©dito de consumo."
      );
      return;
    }

    const buildRow = (label: string, value: string, colorClass = "") => {
      const line = document.createElement("div");
      line.className =
        "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

      const labelElement = document.createElement("span");
      labelElement.className = "text-secondary";
      labelElement.textContent = label;

      const valueElement = document.createElement("span");
      valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
      valueElement.textContent = value;

      line.append(labelElement, valueElement);
      return line;
    };

    const headline = document.createElement("div");
    headline.className =
      "mb-5 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
    const headlineLabel = document.createElement("p");
    headlineLabel.className =
      "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
    headlineLabel.textContent = "Cuota mensual";
    const headlineValue = document.createElement("p");
    headlineValue.className = "text-4xl font-bold";
    headlineValue.textContent = fmt(resultado.monthlyPaymentTotal);
    headline.append(headlineLabel, headlineValue);
    if (seguro > 0) {
      const insuranceNote = document.createElement("p");
      insuranceNote.className = "mt-1 text-xs text-muted";
      insuranceNote.textContent = `Incluye ${fmt(seguro)} de seguro`;
      headline.appendChild(insuranceNote);
    }

    const insight = document.createElement("div");
    insight.className =
      "mt-4 rounded-lg bg-foreground/5 p-3 text-xs text-secondary";
    const highlightedTotal = document.createElement("strong");
    highlightedTotal.textContent = fmt(
      resultado.totalPaid / (monto / 1_000_000)
    );
    insight.append(
      "Por cada $1.000.000 prestado pagas ",
      highlightedTotal,
      " en total - ",
      `${((resultado.totalInterest / monto) * 100).toFixed(0)}% m√°s de lo que te prestaron.`
    );

    const rows = [
      buildRow("Monto solicitado", fmt(monto)),
      buildRow("Plazo", `${plazo} meses`),
      buildRow(
        "Tasa mensual",
        `${(resultado.monthlyRateDecimal * 100).toFixed(4)}%`
      ),
      buildRow(
        "Tasa anual equivalente",
        `${resultado.annualEquivalentRatePercent.toFixed(2)}%`
      ),
      buildRow(
        "CAE (Carga Anual Equiv.)",
        `${resultado.caePercent.toFixed(2)}%`,
        "text-accent"
      ),
      buildRow("Total intereses", fmt(resultado.totalInterest), "text-red-400"),
      ...(gastos > 0
        ? [buildRow("Gastos operacionales", fmt(gastos), "text-red-400")]
        : []),
      buildRow("Total a pagar", fmt(resultado.totalPaid), "text-red-400"),
    ];

    document
      .getElementById("resultado-contenido")!
      .replaceChildren(headline, ...rows, insight);
  });

  // Cambiar label de tasa seg√∫n tipo
  document.querySelectorAll("input[name='tasa-tipo']").forEach(r => {
    r.addEventListener("change", () => {
      const tipo = (
        document.querySelector(
          "input[name='tasa-tipo']:checked"
        ) as HTMLInputElement
      )?.value;
      const input = document.getElementById("tasa") as HTMLInputElement;
      if (tipo === "mensual") {
        input.value = "3.49";
        input.placeholder = "Ej: 3.49";
      } else {
        input.value = "51.5";
        input.placeholder = "Ej: 51.5";
      }
    });
  });
</script>
