---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";
import { getPath } from "@/utils/getPath";

const { parameters: economicParameters } = await getEconomicParameters();
const ufGuidePath = getPath("/posts/que-es-la-uf/");
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
const ufDisplay = economicParameters.uf.toLocaleString("es-CL", {
  minimumFractionDigits: 2,
  maximumFractionDigits: 2,
});
const ufDateDisplay = new Intl.DateTimeFormat("es-CL", {
  dateStyle: "long",
  timeZone: "UTC",
}).format(new Date(`${economicParameters.lastUpdated}T00:00:00.000Z`));
---

<Layout
  title="Conversor UF a Pesos Chile | Tu Plata Informa"
  description="Convierte UF a CLP y CLP a UF con valor diario de referencia y una tabla r√°pida de montos."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üîÑ Conversor UF ‚Üî Pesos
      </h1>
      <p class="max-w-xl text-secondary">
        Convierte entre Unidad de Fomento y pesos chilenos al valor oficial del
        d√≠a. Sin registro, sin publicidad.
      </p>
    </section>

    <section class="max-w-xl py-8">
      <!-- VALOR DEL D√çA -->
      <div
        id="valor-uf-banner"
        class="mb-6 flex items-center justify-between gap-4 rounded-xl border border-accent/30 bg-accent/5 p-4"
      >
        <div>
          <p
            class="mb-0.5 text-xs font-bold tracking-widest text-accent uppercase"
          >
            Valor UF hoy
          </p>
          <p id="uf-display" class="text-3xl font-bold">${"$" + ufDisplay}</p>
          <p id="uf-fecha" class="mt-0.5 text-xs text-muted">
            {ufDateDisplay} ¬∑ Fuente: mindicador.cl
          </p>
        </div>
        <span class="text-4xl">üá®üá±</span>
      </div>

      <!-- CONVERSOR -->
      <div class="mb-6 rounded-xl border border-border p-6">
        <!-- UF ‚Üí Pesos -->
        <div class="mb-6">
          <label
            for="uf-input"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Unidades de Fomento (UF)
          </label>
          <input
            type="number"
            id="uf-input"
            placeholder="Ej: 1000"
            min="0"
            step="0.01"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-lg text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-6 flex items-center gap-3">
          <div class="h-px flex-1 bg-border"></div>
          <button
            id="swap-btn"
            class="rounded-full border border-border px-3 py-1 text-sm text-secondary transition-all hover:border-accent hover:text-accent"
          >
            ‚áÖ invertir
          </button>
          <div class="h-px flex-1 bg-border"></div>
        </div>

        <div class="mb-6">
          <label
            for="pesos-input"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Pesos chilenos ($)
          </label>
          <input
            type="number"
            id="pesos-input"
            placeholder="Ej: 39.773.620"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-lg text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <!-- RESULTADO VISUAL -->
        <div
          id="resultado"
          class="hidden rounded-lg bg-foreground/5 p-4 text-center"
        >
          <p id="resultado-texto" class="text-2xl font-bold"></p>
          <p id="resultado-sub" class="mt-1 text-sm text-muted"></p>
        </div>
        <div
          id="economic-parameters"
          data-uf={String(economicParameters.uf)}
          data-last-updated={economicParameters.lastUpdated}
          class="hidden"
          aria-hidden="true"
        >
        </div>
      </div>

      <!-- TABLA DE REFERENCIA R√ÅPIDA -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-4 text-base font-semibold">
          Valores de referencia r√°pidos
        </h2>
        <div id="tabla-ref" class="space-y-2 text-sm"></div>
        <p class="mt-3 text-xs text-muted">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øQu√© es la UF y por qu√© cambia cada d√≠a?</h2>
      <p>
        La <strong>Unidad de Fomento (UF)</strong> es un √≠ndice de reajustabilidad
        que sigue la inflaci√≥n. Se actualiza diariamente desde el d√≠a 10 de cada mes
        hasta el d√≠a 9 del siguiente, en base al IPC del mes anterior publicado por
        el INE.
      </p>
      <ul>
        <li>
          Si el IPC de enero fue 0,5%, la UF sube ese 0,5% distribuido entre el
          10 de febrero y el 9 de marzo.
        </li>
        <li>
          El valor oficial lo publica el Banco Central en el Diario Oficial a
          m√°s tardar el d√≠a 9 de cada mes.
        </li>
        <li>
          Se usa en arriendos, cr√©ditos hipotecarios, multas y contratos de
          largo plazo.
        </li>
      </ul>
      <p class="text-sm text-muted">
        ‚ö†Ô∏è El valor de la UF en este conversor usa la √∫ltima actualizaci√≥n
        disponible en la fuente. Para validar el dato oficial consulta el <a
          href="https://si3.bcentral.cl/Indicadoressiete/secure/Indicadoresdiarios.aspx"
          target="_blank">Banco Central</a
        >.
      </p>
      <p>
        Para entender por qu√© la UF cambia todos los d√≠as, revisa la <a
          href={ufGuidePath}>gu√≠a explicativa de la UF</a
        >.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { convertUf } from "@/application/use-cases/ConvertUf";

  function readEconomicContext(): { uf: number; lastUpdated: string } {
    const element = document.getElementById("economic-parameters");
    const uf = Number(element?.dataset?.uf);
    const lastUpdated = element?.dataset?.lastUpdated;
    if (!Number.isFinite(uf) || uf <= 0 || !lastUpdated) {
      throw new Error("No se pudo cargar el valor UF para el conversor.");
    }
    return { uf, lastUpdated };
  }

  const economicContext = readEconomicContext();

  const fmt = (n: number) => "$" + Math.round(n).toLocaleString("es-CL");
  const fmtUF = (n: number) =>
    n.toLocaleString("es-CL", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 4,
    }) + " UF";

  const ufInput = document.getElementById("uf-input") as HTMLInputElement;
  const pesosInput = document.getElementById("pesos-input") as HTMLInputElement;
  const resultado = document.getElementById("resultado")!;
  const resultadoTexto = document.getElementById("resultado-texto")!;
  const resultadoSub = document.getElementById("resultado-sub")!;

  function mostrarResultado(principal: string, sub: string) {
    resultado.classList.remove("hidden");
    resultadoTexto.textContent = principal;
    resultadoSub.textContent = sub;
  }

  ufInput.addEventListener("input", () => {
    const uf = parseFloat(ufInput.value);
    if (!isNaN(uf) && uf > 0) {
      const conversion = convertUf({
        amount: uf,
        ufValue: economicContext.uf,
        direction: "uf_to_clp",
      });
      pesosInput.value = String(Math.round(conversion.clpAmount));
      mostrarResultado(
        fmt(conversion.clpAmount),
        `${fmtUF(conversion.ufAmount)} = ${fmt(conversion.clpAmount)} al ${economicContext.lastUpdated}`
      );
    } else {
      pesosInput.value = "";
      resultado.classList.add("hidden");
    }
  });

  pesosInput.addEventListener("input", () => {
    const pesos = parseFloat(pesosInput.value);
    if (!isNaN(pesos) && pesos > 0) {
      const conversion = convertUf({
        amount: pesos,
        ufValue: economicContext.uf,
        direction: "clp_to_uf",
      });
      ufInput.value = conversion.ufAmount.toFixed(4);
      mostrarResultado(
        fmtUF(conversion.ufAmount),
        `${fmt(conversion.clpAmount)} = ${fmtUF(conversion.ufAmount)} al ${economicContext.lastUpdated}`
      );
    } else {
      ufInput.value = "";
      resultado.classList.add("hidden");
    }
  });

  document.getElementById("swap-btn")?.addEventListener("click", () => {
    const ufVal = ufInput.value;
    const pesosVal = pesosInput.value;
    ufInput.value = pesosVal
      ? String(parseFloat(pesosVal) / economicContext.uf)
      : "";
    pesosInput.value = ufVal
      ? String(Math.round(parseFloat(ufVal) * economicContext.uf))
      : "";
    ufInput.dispatchEvent(new Event("input"));
  });

  // Tabla de referencia
  const refs = [
    { label: "1 UF", uf: 1 },
    { label: "10 UF", uf: 10 },
    { label: "50 UF (tope Ley fraude)", uf: 50 },
    { label: "80 UF (m√≠nimo Superir)", uf: 80 },
    { label: "100 UF", uf: 100 },
    { label: "500 UF", uf: 500 },
    { label: "600 UF (tope APV anual)", uf: 600 },
    { label: "1.000 UF", uf: 1000 },
    { label: "2 mil UF (precio aprox. depto. chico)", uf: 2_000 },
  ];

  const tablaEl = document.getElementById("tabla-ref")!;
  const tableRows = refs.map(reference => {
    const row = document.createElement("div");
    row.className =
      "flex justify-between border-b border-border py-1.5 last:border-0";

    const label = document.createElement("span");
    label.className = "text-secondary";
    label.textContent = reference.label;

    const value = document.createElement("span");
    value.className = "font-mono font-semibold";
    value.textContent = fmt(reference.uf * economicContext.uf);

    row.append(label, value);
    return row;
  });
  tablaEl.replaceChildren(...tableRows);
</script>
