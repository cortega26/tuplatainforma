---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";

const { parameters: economicParameters } = await getEconomicParameters();
const firstTaxExemptBracket = 13.5 * economicParameters.utm;
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
---

<Layout
  title="Calculadora de Sueldo L√≠quido Chile"
  description="Calcula tu sueldo l√≠quido con desglose de AFP, salud, seguro de cesant√≠a e impuesto de segunda categor√≠a."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üí∞ Calculadora de Sueldo L√≠quido
      </h1>
      <p class="max-w-xl text-foreground/70">
        Ingresa tu sueldo bruto y obt√©n el desglose exacto de AFP, salud, seguro
        de cesant√≠a e impuesto de segunda categor√≠a.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Ingresa tus datos</h2>

        <div class="mb-4">
          <label
            for="sueldo"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Sueldo bruto mensual ($)
          </label>
          <input
            type="number"
            id="sueldo"
            placeholder="Ej: 1.200.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            El sueldo antes de cualquier descuento
          </p>
        </div>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-foreground/70"
            >Sistema de salud</label
          >
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="salud"
                value="fonasa"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Fonasa (7%)
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="salud"
                value="isapre"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Isapre (7%+)
              </span>
            </label>
          </div>
        </div>

        <div id="isapre-field" class="mb-4 hidden">
          <label
            for="isapre-adicional"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Cotizaci√≥n adicional Isapre (%)
          </label>
          <input
            type="number"
            id="isapre-adicional"
            placeholder="Ej: 2.5"
            min="0"
            max="20"
            step="0.1"
            value="2"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Porcentaje adicional al 7% base seg√∫n tu plan
          </p>
        </div>

        <div class="mb-4">
          <label
            for="afp-tasa"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            AFP
          </label>
          <select
            id="afp-tasa"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          >
            <option value="10.58">Capital ‚Äì 10.58%</option>
            <option value="10.65">Cuprum ‚Äì 10.65%</option>
            <option value="10.77" selected>Habitat ‚Äì 10.77%</option>
            <option value="10.58">Modelo ‚Äì 10.58%</option>
            <option value="10.49">PlanVital ‚Äì 10.49%</option>
            <option value="10.69">ProVida ‚Äì 10.69%</option>
            <option value="10.75">Uno ‚Äì 10.75%</option>
          </select>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular sueldo l√≠quido ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üíµ Resultado</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">üßÆ</p>
          <p class="text-sm">Ingresa tu sueldo y presiona calcular.</p>
        </div>
        <div
          id="economic-parameters"
          data-utm={String(economicParameters.utm)}
          class="hidden"
          aria-hidden="true"
        >
        </div>
        <p class="mt-3 text-xs text-foreground/40">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øC√≥mo se calcula el sueldo l√≠quido en Chile?</h2>
      <p>
        El sueldo l√≠quido es lo que efectivamente depositan en tu cuenta cada
        mes. Se obtiene restando al sueldo bruto las cotizaciones previsionales
        y, si corresponde, el impuesto de segunda categor√≠a.
      </p>
      <ul>
        <li>
          <strong>AFP (10% + comisi√≥n):</strong> Entre 10.49% y 10.77% seg√∫n tu AFP.
          El 10% va a tu fondo personal, el resto es la comisi√≥n del servicio.
        </li>
        <li>
          <strong>Salud (7%):</strong> Va a Fonasa o tu Isapre para cubrir atenci√≥n
          m√©dica.
        </li>
        <li>
          <strong>Seguro de cesant√≠a (0.6%):</strong> Fondo para periodos de desempleo.
        </li>
        <li>
          <strong>Impuesto de segunda categor√≠a:</strong> Solo aplica si tu sueldo
          supera el primer tramo exento (~${
            "$" + Math.round(firstTaxExemptBracket).toLocaleString("es-CL")
          }). Es progresivo.
        </li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Esta calculadora entrega valores referenciales. Para informaci√≥n
        oficial consulta la <a href="https://www.spensiones.cl" target="_blank"
          >Superintendencia de Pensiones</a
        > y el <a href="https://www.sii.cl" target="_blank">SII</a>.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { calculateNetSalary } from "@/application/use-cases/CalculateNetSalary";

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtPct(n: number): string {
    return n.toFixed(2) + "%";
  }

  function readEconomicUtm(): number {
    const element = document.getElementById("economic-parameters");
    const rawValue = element?.dataset?.utm;
    const parsedValue = Number(rawValue);
    if (!Number.isFinite(parsedValue) || parsedValue <= 0) {
      throw new Error("No se pudo cargar el valor UTM para el c√°lculo.");
    }
    return parsedValue;
  }

  const utm = readEconomicUtm();

  // Toggle Isapre
  document.querySelectorAll("input[name='salud']").forEach(radio => {
    radio.addEventListener("change", () => {
      const isIsapre =
        (
          document.querySelector(
            "input[name='salud']:checked"
          ) as HTMLInputElement
        )?.value === "isapre";
      const field = document.getElementById("isapre-field");
      if (field) field.classList.toggle("hidden", !isIsapre);
    });
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const bruto =
      parseFloat(
        (document.getElementById("sueldo") as HTMLInputElement).value
      ) || 0;
    if (bruto <= 0) {
      alert("Por favor ingresa un sueldo v√°lido.");
      return;
    }

    const afpTasaPercent = parseFloat(
      (document.getElementById("afp-tasa") as HTMLSelectElement).value
    );
    const healthSystem =
      (
        document.querySelector(
          "input[name='salud']:checked"
        ) as HTMLInputElement
      )?.value === "isapre"
        ? "isapre"
        : "fonasa";
    const isapreAdicional =
      parseFloat(
        (document.getElementById("isapre-adicional") as HTMLInputElement).value
      ) || 0;

    let resultado;
    try {
      resultado = calculateNetSalary({
        grossSalary: bruto,
        afpRatePercent: afpTasaPercent,
        healthSystem,
        isapreAdditionalPercent: isapreAdicional,
        economicParameters: { utm },
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo calcular el sueldo l√≠quido."
      );
      return;
    }

    const buildRow = (label: string, value: string, colorClass = "") => {
      const line = document.createElement("div");
      line.className =
        "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

      const labelElement = document.createElement("span");
      labelElement.className = "text-foreground/60";
      labelElement.textContent = label;

      const valueElement = document.createElement("span");
      valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
      valueElement.textContent = value;

      line.append(labelElement, valueElement);
      return line;
    };

    const headline = document.createElement("div");
    headline.className =
      "mb-6 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
    const headlineLabel = document.createElement("p");
    headlineLabel.className =
      "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
    headlineLabel.textContent = "Sueldo L√≠quido";
    const headlineValue = document.createElement("p");
    headlineValue.className = "text-4xl font-bold";
    headlineValue.textContent = fmt(resultado.netSalary);
    headline.append(headlineLabel, headlineValue);

    const totals = document.createElement("div");
    totals.className = "mt-3 flex justify-between pt-3 text-sm font-semibold";
    const totalsLabel = document.createElement("span");
    totalsLabel.textContent = "Total descuentos";
    const totalsValue = document.createElement("span");
    totalsValue.className = "text-red-400";
    totalsValue.textContent = `${fmt(resultado.deductions.total)} (${fmtPct(resultado.effectiveRates.totalDeductionPercent)})`;
    totals.append(totalsLabel, totalsValue);

    document
      .getElementById("resultado-contenido")!
      .replaceChildren(
        headline,
        buildRow("Sueldo bruto", fmt(bruto), "text-green-500"),
        buildRow(
          `AFP (${fmtPct(resultado.effectiveRates.afpPercent)})`,
          `‚àí ${fmt(resultado.deductions.afp)}`,
          "text-red-400"
        ),
        buildRow(
          `Salud (${fmtPct(resultado.effectiveRates.healthPercent)})`,
          `‚àí ${fmt(resultado.deductions.health)}`,
          "text-red-400"
        ),
        buildRow(
          `Seg. cesant√≠a (${fmtPct(resultado.effectiveRates.unemploymentInsurancePercent)})`,
          `‚àí ${fmt(resultado.deductions.unemploymentInsurance)}`,
          "text-red-400"
        ),
        buildRow(
          "Imp. 2¬™ categor√≠a",
          `‚àí ${fmt(resultado.deductions.tax)}`,
          "text-red-400"
        ),
        totals
      );
  });

  document
    .getElementById("sueldo")
    ?.addEventListener("keydown", (e: KeyboardEvent) => {
      if (e.key === "Enter")
        (document.getElementById("calcBtn") as HTMLButtonElement)?.click();
    });
</script>
