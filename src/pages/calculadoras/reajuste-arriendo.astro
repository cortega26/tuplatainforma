---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";

const { parameters: economicParameters } = await getEconomicParameters();
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
---

<Layout
  title="Calculadora de Reajuste de Arriendo | UF, IPC y Pesos"
  description="Calcula el reajuste de arriendo seg√∫n variaci√≥n de UF o IPC y estima tu nuevo canon mensual."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üè† Calculadora de Reajuste de Arriendo
      </h1>
      <p class="max-w-xl text-foreground/70">
        Calcula cu√°nto sube tu arriendo seg√∫n la variaci√≥n de la UF o el IPC.
        √ötil tanto para arrendatarios como para propietarios.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Datos del arriendo</h2>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-foreground/70"
            >Tipo de reajuste seg√∫n contrato</label
          >
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="tipo"
                value="uf"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                En UF
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="tipo"
                value="ipc"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Por IPC
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="tipo"
                value="pesos"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Pesos fijos
              </span>
            </label>
          </div>
        </div>

        <!-- CAMPOS UF -->
        <div id="campos-uf">
          <div class="mb-4">
            <label
              for="arriendo-uf"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Monto del arriendo en UF
            </label>
            <input
              type="number"
              id="arriendo-uf"
              placeholder="Ej: 15.5"
              min="0"
              step="0.01"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
          </div>
          <div class="mb-4">
            <label
              for="uf-antes"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Valor UF al pagar el √∫ltimo arriendo ($)
            </label>
            <input
              type="number"
              id="uf-antes"
              placeholder="Ej: 38.500"
              min="0"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
          </div>
          <div class="mb-4">
            <label
              for="uf-hoy"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Valor UF hoy ($)
            </label>
            <input
              type="number"
              id="uf-hoy"
              value={String(economicParameters.uf)}
              min="0"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
            <p class="mt-1 text-xs text-foreground/50">
              Valor cargado desde par√°metros econ√≥micos vigentes. Ajusta si es
              necesario.
            </p>
          </div>
        </div>

        <!-- CAMPOS IPC -->
        <div id="campos-ipc" class="hidden">
          <div class="mb-4">
            <label
              for="arriendo-pesos-ipc"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Arriendo actual en pesos ($)
            </label>
            <input
              type="number"
              id="arriendo-pesos-ipc"
              placeholder="Ej: 450.000"
              min="0"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
          </div>
          <div class="mb-4">
            <label
              for="ipc-variacion"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Variaci√≥n IPC del per√≠odo (%)
            </label>
            <input
              type="number"
              id="ipc-variacion"
              placeholder="Ej: 4.7"
              step="0.1"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
            <p class="mt-1 text-xs text-foreground/50">
              IPC acumulado del a√±o o del per√≠odo pactado. Verifica en <a
                href="https://www.ine.cl"
                target="_blank"
                class="underline">ine.cl</a
              >.
            </p>
          </div>
        </div>

        <!-- CAMPOS PESOS FIJOS -->
        <div id="campos-pesos" class="hidden">
          <div class="mb-4">
            <label
              for="arriendo-pesos"
              class="mb-1 block text-sm font-medium text-foreground/70"
            >
              Arriendo actual en pesos ($)
            </label>
            <input
              type="number"
              id="arriendo-pesos"
              placeholder="Ej: 450.000"
              min="0"
              class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
            />
          </div>
          <div
            class="mb-4 rounded-lg border border-yellow-500/20 bg-yellow-500/10 p-3 text-sm text-foreground/70"
          >
            ‚ö†Ô∏è Un contrato en pesos fijos <strong
              >no se reajusta autom√°ticamente</strong
            >. El propietario solo puede subir el arriendo al renovar o
            renegociar el contrato. Si el contrato dice "reajuste por IPC" o
            "por UF", usa las otras opciones.
          </div>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular reajuste ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üìä Resultado</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">üè†</p>
          <p class="text-sm">Ingresa los datos para calcular el reajuste.</p>
        </div>
        <div
          id="economic-parameters"
          data-uf={String(economicParameters.uf)}
          class="hidden"
          aria-hidden="true"
        >
        </div>
        <p class="mt-3 text-xs text-foreground/40">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øC√≥mo se reajusta legalmente un arriendo en Chile?</h2>
      <p>
        En Chile, el reajuste del arriendo depende de lo que diga el contrato.
        La ley no obliga a usar UF ni IPC; simplemente exige respetar lo
        pactado. Los tres casos m√°s comunes son:
      </p>
      <ul>
        <li>
          <strong>Contrato en UF:</strong> El arriendo se convierte a pesos al valor
          de la UF del d√≠a de pago. No hay "reajuste" propiamente tal: el monto en
          UF es fijo, pero su equivalencia en pesos sube con la inflaci√≥n autom√°ticamente
          cada mes.
        </li>
        <li>
          <strong>Contrato con reajuste anual por IPC:</strong> El arriendo en pesos
          sube una vez al a√±o seg√∫n la variaci√≥n del IPC del per√≠odo. El propietario
          debe avisar con anticipaci√≥n y el reajuste aplica desde la renovaci√≥n anual.
        </li>
        <li>
          <strong>Contrato en pesos fijos sin cl√°usula:</strong> El monto no cambia
          hasta que se acuerde una modificaci√≥n. El propietario no puede subir unilateralmente
          el precio durante la vigencia del contrato.
        </li>
      </ul>
      <p>
        Ante cualquier duda o conflicto, el organismo competente es el <strong
          >Juzgado de Letras con competencia en arrendamiento</strong
        >. El SERNAC no tiene competencia en arriendos de vivienda.
      </p>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Esta calculadora entrega valores referenciales. Para interpretaci√≥n
        legal de tu contrato, consulta a un abogado o la <a
          href="https://www.corporacionderechopublico.cl"
          target="_blank">Corporaci√≥n de Asistencia Judicial</a
        >.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import {
    calculateIpcRentAdjustment,
    calculateUfRentAdjustment,
  } from "@/application/use-cases/CalculateRentAdjustment";

  function fmt(n: number) {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function buildRow(
    label: string,
    value: string,
    colorClass = ""
  ): HTMLDivElement {
    const line = document.createElement("div");
    line.className =
      "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

    const labelElement = document.createElement("span");
    labelElement.className = "text-foreground/60";
    labelElement.textContent = label;

    const valueElement = document.createElement("span");
    valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
    valueElement.textContent = value;

    line.append(labelElement, valueElement);
    return line;
  }

  // Toggle campos
  document.querySelectorAll("input[name='tipo']").forEach(r => {
    r.addEventListener("change", () => {
      const val = (
        document.querySelector("input[name='tipo']:checked") as HTMLInputElement
      )?.value;
      document
        .getElementById("campos-uf")!
        .classList.toggle("hidden", val !== "uf");
      document
        .getElementById("campos-ipc")!
        .classList.toggle("hidden", val !== "ipc");
      document
        .getElementById("campos-pesos")!
        .classList.toggle("hidden", val !== "pesos");
    });
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const tipo = (
      document.querySelector("input[name='tipo']:checked") as HTMLInputElement
    )?.value;

    if (tipo === "pesos") {
      const arriendo =
        parseFloat(
          (document.getElementById("arriendo-pesos") as HTMLInputElement).value
        ) || 0;
      const box = document.createElement("div");
      box.className =
        "rounded-lg border border-yellow-500/30 bg-yellow-500/10 p-4 text-sm text-foreground/70";

      const title = document.createElement("p");
      title.className = "mb-2 font-bold text-yellow-500";
      title.textContent = "Sin reajuste autom√°tico";

      const paragraph1 = document.createElement("p");
      const strongAmount = document.createElement("strong");
      strongAmount.textContent = fmt(arriendo);
      paragraph1.append(
        "Tu arriendo actual es ",
        strongAmount,
        ". Con un contrato en pesos fijos sin cl√°usula de reajuste, este monto no cambia hasta que se modifique el contrato de mutuo acuerdo."
      );

      const paragraph2 = document.createElement("p");
      paragraph2.className = "mt-2";
      paragraph2.textContent =
        "Si tu contrato s√≠ tiene cl√°usula de reajuste por UF o IPC, usa las otras opciones del formulario.";

      box.append(title, paragraph1, paragraph2);
      document.getElementById("resultado-contenido")!.replaceChildren(box);
      return;
    }

    if (tipo === "uf") {
      const arriendoUF =
        parseFloat(
          (document.getElementById("arriendo-uf") as HTMLInputElement).value
        ) || 0;
      const ufAntes =
        parseFloat(
          (document.getElementById("uf-antes") as HTMLInputElement).value
        ) || 0;
      const ufHoy =
        parseFloat(
          (document.getElementById("uf-hoy") as HTMLInputElement).value
        ) || 0;

      if (arriendoUF <= 0 || ufAntes <= 0 || ufHoy <= 0) {
        alert("Completa todos los campos de UF.");
        return;
      }

      let reajusteUf;
      try {
        reajusteUf = calculateUfRentAdjustment({
          rentUf: arriendoUF,
          previousUfValue: ufAntes,
          currentUfValue: ufHoy,
        });
      } catch (error) {
        alert(
          error instanceof Error
            ? error.message
            : "No se pudo calcular el reajuste por UF."
        );
        return;
      }

      const header = document.createElement("div");
      header.className =
        "mb-5 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
      const headerTitle = document.createElement("p");
      headerTitle.className =
        "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
      headerTitle.textContent = "Arriendo este mes";
      const headerValue = document.createElement("p");
      headerValue.className = "text-4xl font-bold";
      headerValue.textContent = fmt(reajusteUf.currentRentClp);
      const headerSub = document.createElement("p");
      headerSub.className = "mt-1 text-sm text-foreground/50";
      headerSub.textContent = `${arriendoUF.toLocaleString("es-CL", {
        minimumFractionDigits: 2,
      })} UF √ó $${Math.round(ufHoy).toLocaleString("es-CL")}`;
      header.append(headerTitle, headerValue, headerSub);

      const note = document.createElement("p");
      note.className = "mt-3 text-xs text-foreground/40";
      note.textContent = `El arriendo en UF no "sube" - siempre son ${arriendoUF} UF. Lo que var√≠a es el equivalente en pesos seg√∫n el valor diario de la UF.`;

      document
        .getElementById("resultado-contenido")!
        .replaceChildren(
          header,
          buildRow("Arriendo mes anterior", fmt(reajusteUf.previousRentClp)),
          buildRow(
            "Diferencia",
            `${reajusteUf.differenceClp >= 0 ? "+ " : ""}${fmt(reajusteUf.differenceClp)}`,
            reajusteUf.differenceClp > 0 ? "text-red-400" : "text-green-500"
          ),
          buildRow(
            "Variaci√≥n UF del per√≠odo",
            `${reajusteUf.ufVariationPercent.toFixed(2)}%`
          ),
          note
        );
      return;
    }

    if (tipo === "ipc") {
      const arriendoPesos =
        parseFloat(
          (document.getElementById("arriendo-pesos-ipc") as HTMLInputElement)
            .value
        ) || 0;
      const ipcVariacion = parseFloat(
        (document.getElementById("ipc-variacion") as HTMLInputElement).value
      );

      if (arriendoPesos <= 0 || isNaN(ipcVariacion)) {
        alert("Completa el arriendo actual y la variaci√≥n IPC.");
        return;
      }

      let reajusteIpc;
      try {
        reajusteIpc = calculateIpcRentAdjustment({
          currentRentClp: arriendoPesos,
          ipcVariationPercent: ipcVariacion,
        });
      } catch (error) {
        alert(
          error instanceof Error
            ? error.message
            : "No se pudo calcular el reajuste por IPC."
        );
        return;
      }

      const header = document.createElement("div");
      header.className =
        "mb-5 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
      const headerTitle = document.createElement("p");
      headerTitle.className =
        "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
      headerTitle.textContent = "Arriendo reajustado";
      const headerValue = document.createElement("p");
      headerValue.className = "text-4xl font-bold";
      headerValue.textContent = fmt(reajusteIpc.adjustedRentClp);
      const headerSub = document.createElement("p");
      headerSub.className = "mt-1 text-sm text-foreground/50";
      headerSub.textContent = `Con IPC ${ipcVariacion > 0 ? "+" : ""}${ipcVariacion}%`;
      header.append(headerTitle, headerValue, headerSub);

      const note = document.createElement("p");
      note.className = "mt-3 text-xs text-foreground/40";
      note.textContent =
        "El reajuste por IPC aplica sobre el monto en pesos pactado. Solo puede hacerse en la fecha de renovaci√≥n anual indicada en el contrato.";

      document
        .getElementById("resultado-contenido")!
        .replaceChildren(
          header,
          buildRow("Arriendo antes del reajuste", fmt(arriendoPesos)),
          buildRow(
            "Aumento mensual",
            `+ ${fmt(reajusteIpc.differenceClp)}`,
            "text-red-400"
          ),
          buildRow(
            "Aumento anual",
            `+ ${fmt(reajusteIpc.differenceClp * 12)}`,
            "text-red-400"
          ),
          buildRow(
            "Factor aplicado",
            `√ó${reajusteIpc.appliedFactor.toFixed(4)}`
          ),
          note
        );
    }
  });
</script>
