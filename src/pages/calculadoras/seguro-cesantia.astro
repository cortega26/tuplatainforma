---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";

const { parameters: economicParameters } = await getEconomicParameters();
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
---

<Layout
  title="Calculadora de Seguro de Cesant√≠a | CIC y Fondo Solidario"
  description="Estima tu cobertura del seguro de cesant√≠a en Chile seg√∫n sueldo, cotizaciones, causal y saldo CIC."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üõ°Ô∏è Calculadora de Seguro de Cesant√≠a
      </h1>
      <p class="max-w-xl text-secondary">
        Estima cu√°nto tienes acumulado en tu Cuenta Individual de Cesant√≠a (CIC)
        y cu√°nto recibir√≠as cada mes si quedaras sin trabajo.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Tus datos</h2>

        <div class="mb-4">
          <label
            for="sueldo"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Sueldo bruto mensual ($)
          </label>
          <input
            type="number"
            id="sueldo"
            placeholder="Ej: 1.200.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-secondary"
            >Tipo de contrato</label
          >
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="contrato"
                value="indefinido"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Indefinido
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="contrato"
                value="plazo-fijo"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Plazo fijo / obra
              </span>
            </label>
          </div>
        </div>

        <div class="mb-4">
          <label
            for="meses-cotizados"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Meses cotizados en este trabajo
          </label>
          <input
            type="number"
            id="meses-cotizados"
            placeholder="Ej: 24"
            min="1"
            max="600"
            value="24"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            Meses desde que ingresaste o desde el √∫ltimo cobro del seguro.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="saldo-actual"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Saldo actual en CIC ($) ‚Äî opcional
          </label>
          <input
            type="number"
            id="saldo-actual"
            placeholder="Cons√∫ltalo en afc.cl"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            Si lo ingresas, el resultado es m√°s preciso. Si no, estimamos seg√∫n
            cotizaciones.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="causal"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Causal de t√©rmino
          </label>
          <select
            id="causal"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          >
            <option value="necesidad">Necesidad de la empresa (art. 161)</option
            >
            <option value="vencimiento"
              >Vencimiento de plazo / conclusi√≥n de obra</option
            >
            <option value="acuerdo">Mutuo acuerdo (art. 163 bis)</option>
            <option value="renuncia">Renuncia voluntaria</option>
            <option value="despido-culpa"
              >Despido por conducta (art. 160)</option
            >
          </select>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular cesant√≠a ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üí∞ Tu cobertura estimada</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-muted"
        >
          <p class="mb-3 text-4xl">üõ°Ô∏è</p>
          <p class="text-sm">Ingresa tus datos y presiona calcular.</p>
        </div>
        <div
          id="economic-parameters"
          data-uf={String(economicParameters.uf)}
          data-afc-monthly-taxable-cap-uf={String(
            economicParameters.afcTopes?.monthlyTaxableCapUf ?? 131.9
          )}
          class="hidden"
          aria-hidden="true"
        >
        </div>
        <p class="mt-3 text-xs text-muted">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øC√≥mo funciona el Seguro de Cesant√≠a?</h2>
      <p>
        El Seguro de Cesant√≠a tiene dos fondos: tu <strong
          >Cuenta Individual (CIC)</strong
        >, que es solo tuya, y el <strong>Fondo Solidario (FCS)</strong>, que es
        compartido. Siempre se usa primero la CIC; el FCS solo entra si tu saldo
        individual es insuficiente y cumples los requisitos.
      </p>
      <ul>
        <li>
          <strong>Contrato indefinido:</strong> aportas 0,6% y tu empleador 2,4% ‚Üí
          3% total mensual sobre tu sueldo imponible.
        </li>
        <li>
          <strong>Plazo fijo / obra:</strong> solo aporta el empleador (3%). A ti
          no te descuentan nada.
        </li>
        <li>
          <strong>M√≠nimo para cobrar:</strong> 6 cotizaciones si es indefinido; 3
          cotizaciones si es plazo fijo.
        </li>
        <li>
          <strong>Para acceder al FCS:</strong> 10 cotizaciones en los √∫ltimos 24
          meses, las 3 √∫ltimas continuas, y la causal debe ser despido por necesidad,
          vencimiento de plazo u otras causales espec√≠ficas.
        </li>
      </ul>
      <p class="text-sm text-muted">
        ‚ö†Ô∏è Esta calculadora entrega estimaciones. El saldo exacto de tu CIC est√°
        en <a href="https://www.afc.cl" target="_blank">afc.cl</a> con tu Clave√önica.
        Los montos del FCS se actualizan anualmente.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { estimateUnemploymentCoverage } from "@/application/use-cases/EstimateUnemploymentCoverage";
  import { animateCount } from "@/utils/animateCount";
  const currencyFormatter = new Intl.NumberFormat("es-CL", {
    style: "currency",
    currency: "CLP",
    maximumFractionDigits: 0,
  });

  function fmtCurrency(n: number): string {
    return currencyFormatter.format(Math.round(n));
  }

  function animatedCurrency(value: number): HTMLSpanElement {
    const target = Math.round(value);
    const span = document.createElement("span");
    span.dataset.animate = "true";
    span.dataset.target = String(target);
    span.textContent = fmtCurrency(target);
    return span;
  }

  function row(
    label: string,
    value: string | Node,
    colorClass = ""
  ): HTMLDivElement {
    const line = document.createElement("div");
    line.className =
      "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

    const labelElement = document.createElement("span");
    labelElement.className = "text-secondary";
    labelElement.textContent = label;

    const valueElement = document.createElement("span");
    valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
    if (typeof value === "string") {
      valueElement.textContent = value;
    } else {
      valueElement.appendChild(value);
    }

    line.append(labelElement, valueElement);
    return line;
  }

  function badge(texto: string, colorClass: string): HTMLSpanElement {
    const badgeElement = document.createElement("span");
    badgeElement.className = `inline-block rounded-full px-2 py-0.5 text-xs font-bold ${colorClass}`;
    badgeElement.textContent = texto;
    return badgeElement;
  }

  function readEconomicParameters(): {
    uf: number;
    afcMonthlyTaxableCapUf: number;
  } {
    const element = document.getElementById("economic-parameters");
    const uf = Number(element?.dataset?.uf);
    const afcMonthlyTaxableCapUf = Number(
      element?.dataset?.afcMonthlyTaxableCapUf
    );

    if (
      !Number.isFinite(uf) ||
      uf <= 0 ||
      !Number.isFinite(afcMonthlyTaxableCapUf) ||
      afcMonthlyTaxableCapUf <= 0
    ) {
      throw new Error("No se pudieron cargar los par√°metros econ√≥micos AFC.");
    }

    return { uf, afcMonthlyTaxableCapUf };
  }

  const economicParameters = readEconomicParameters();

  function animateResultValues() {
    const container = document.getElementById("resultado-contenido");
    if (!container) return;

    const reduceMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)"
    ).matches;

    container.querySelectorAll("[data-animate='true']").forEach(element => {
      const htmlElement = element as HTMLElement;
      const target = Number(htmlElement.dataset.target ?? "0");

      if (reduceMotion) {
        htmlElement.textContent = fmtCurrency(target);
        return;
      }

      htmlElement.textContent = fmtCurrency(0);
      animateCount(htmlElement, target, 800, n => fmtCurrency(n));
    });
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const sueldo =
      parseFloat(
        (document.getElementById("sueldo") as HTMLInputElement).value
      ) || 0;
    const mesesCotizados =
      parseInt(
        (document.getElementById("meses-cotizados") as HTMLInputElement).value
      ) || 0;
    const saldoIngresado =
      parseFloat(
        (document.getElementById("saldo-actual") as HTMLInputElement).value
      ) || 0;
    const contrato = (
      document.querySelector(
        "input[name='contrato']:checked"
      ) as HTMLInputElement
    )?.value;
    const causal = (document.getElementById("causal") as HTMLSelectElement)
      .value;

    if (sueldo <= 0) {
      alert("Por favor ingresa tu sueldo bruto mensual.");
      return;
    }

    let estimacion;
    try {
      estimacion = estimateUnemploymentCoverage({
        grossSalary: sueldo,
        contractType: contrato as "indefinido" | "plazo-fijo",
        terminationCause: causal as
          | "necesidad"
          | "vencimiento"
          | "acuerdo"
          | "renuncia"
          | "despido-culpa",
        monthsContributed: mesesCotizados,
        currentCicBalance: saldoIngresado > 0 ? saldoIngresado : undefined,
        economicParameters: {
          uf: economicParameters.uf,
          afcTopes: {
            monthlyTaxableCapUf: economicParameters.afcMonthlyTaxableCapUf,
          },
        },
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo calcular el seguro de cesant√≠a."
      );
      return;
    }

    if (!estimacion.meetsMinimumContributions) {
      const warning = document.createElement("div");
      warning.className =
        "rounded-lg border border-red-500/30 bg-red-500/10 p-4 text-sm";

      const title = document.createElement("p");
      title.className = "mb-1 font-bold text-red-400";
      title.textContent = "‚ö†Ô∏è No cumples el m√≠nimo a√∫n";

      const message = document.createElement("p");
      message.className = "text-secondary";
      const strong = document.createElement("strong");
      strong.textContent = `${estimacion.minimumContributionsRequired} cotizaciones`;
      message.append(
        "Necesitas al menos ",
        strong,
        ` para cobrar. Llevas ${mesesCotizados}.`
      );

      const missing = document.createElement("p");
      missing.className = "mt-2 text-secondary";
      const remaining =
        estimacion.minimumContributionsRequired - mesesCotizados;
      missing.textContent = `Te faltan ${remaining} ${remaining === 1 ? "mes" : "meses"}.`;

      warning.append(title, message, missing);
      document.getElementById("resultado-contenido")!.replaceChildren(warning);
    } else {
      const header = document.createElement("div");
      header.className =
        "mb-5 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
      const headerTitle = document.createElement("p");
      headerTitle.className =
        "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
      headerTitle.textContent = "Saldo CIC estimado";
      const headerValue = document.createElement("p");
      headerValue.className = "text-4xl font-bold";
      headerValue.appendChild(animatedCurrency(estimacion.estimatedCicBalance));
      const headerSubtitle = document.createElement("p");
      headerSubtitle.className = "mt-1 text-xs text-muted";
      headerSubtitle.textContent =
        saldoIngresado > 0
          ? "Seg√∫n saldo ingresado"
          : "Estimado (ingresa saldo real desde afc.cl para m√°s precisi√≥n)";
      header.append(headerTitle, headerValue, headerSubtitle);

      const payoutsLabel = document.createElement("p");
      payoutsLabel.className =
        "mb-2 text-xs font-bold text-muted uppercase";
      payoutsLabel.textContent = "Pagos estimados por mes";

      const payoutRows = estimacion.payouts.map(
        (payout: number, index: number) => {
          if (payout > 0) {
            return row(
              `Mes ${index + 1} (${(estimacion.payoutRates[index] * 100).toFixed(0)}% del sueldo)`,
              animatedCurrency(payout),
              index === 0 ? "text-accent" : ""
            );
          }

          return row(`Mes ${index + 1}`, "Sin saldo", "text-muted");
        }
      );

      const totalCoverage = document.createElement("div");
      totalCoverage.className =
        "mt-4 flex justify-between border-t border-border pt-3 text-sm font-semibold";
      const totalCoverageLabel = document.createElement("span");
      totalCoverageLabel.textContent = "Total cobertura CIC";
      const totalCoverageValue = document.createElement("span");
      totalCoverageValue.append(
        animatedCurrency(estimacion.totalCoverage),
        ` ¬∑ ${estimacion.monthsCovered} ${estimacion.monthsCovered === 1 ? "mes" : "meses"}`
      );
      totalCoverage.append(totalCoverageLabel, totalCoverageValue);

      const solidarityBox = document.createElement("div");
      solidarityBox.className = `mt-4 rounded-lg border p-3 text-sm ${
        estimacion.eligibleForSolidarityFund
          ? "border-green-500/30 bg-green-500/5"
          : "border-foreground/10 bg-foreground/5"
      }`;
      const solidarityHeader = document.createElement("p");
      solidarityHeader.className = "mb-1 font-bold";
      solidarityHeader.append(
        "Fondo Solidario (FCS) ",
        badge(
          estimacion.eligibleForSolidarityFund
            ? "Acceso posible"
            : "Sin acceso",
          estimacion.eligibleForSolidarityFund
            ? "bg-green-500/20 text-green-500"
            : "bg-foreground/10 text-muted"
        )
      );
      const solidarityMessage = document.createElement("p");
      solidarityMessage.className = "text-secondary";
      solidarityMessage.textContent = estimacion.eligibleForSolidarityFund
        ? `Con ${mesesCotizados} cotizaciones y causal v√°lida podr√≠as acceder al FCS para extender tu cobertura hasta 5 meses. El monto lo define la Superintendencia de Pensiones anualmente.`
        : causal === "renuncia" || causal === "despido-culpa"
          ? "La causal seleccionada no da acceso al FCS. Solo puedes cobrar tu CIC."
          : `Necesitas al menos 10 cotizaciones en los √∫ltimos 24 meses. Llevas ${mesesCotizados}.`;
      solidarityBox.append(solidarityHeader, solidarityMessage);

      const finalNote = document.createElement("p");
      finalNote.className = "mt-3 text-xs text-muted";
      finalNote.append("Consulta tu saldo real en ");
      const afcLink = document.createElement("a");
      afcLink.href = "https://www.afc.cl";
      afcLink.target = "_blank";
      afcLink.className = "underline";
      afcLink.textContent = "afc.cl";
      finalNote.append(afcLink, " con tu Clave√önica.");

      document
        .getElementById("resultado-contenido")!
        .replaceChildren(
          header,
          payoutsLabel,
          ...payoutRows,
          totalCoverage,
          solidarityBox,
          finalNote
        );
    }
    animateResultValues();
  });
</script>
