---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Costo Real de Tarjeta de Cr√©dito | Pago M√≠nimo"
  description="Simula cu√°nto pagas en intereses y tiempo al cubrir pago m√≠nimo o cuota fija de tarjeta de cr√©dito."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üí≥ Costo Real de la Tarjeta de Cr√©dito
      </h1>
      <p class="max-w-xl text-foreground/70">
        Descubre cu√°nto pagas realmente si solo abonas el m√≠nimo de tu tarjeta.
        Ve el costo total en tiempo e intereses.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Datos de tu deuda</h2>

        <div class="mb-4">
          <label
            for="deuda"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Deuda actual ($)
          </label>
          <input
            type="number"
            id="deuda"
            placeholder="Ej: 500.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="tasa"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Tasa de inter√©s mensual (%)
          </label>
          <input
            type="number"
            id="tasa"
            placeholder="Ej: 3.5"
            min="0"
            max="10"
            step="0.01"
            value="3.49"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            La TMC (tasa m√°xima convencional) vigente para tarjetas suele estar
            ~3.49% mensual. Revisa tu contrato para el valor exacto.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="pago-minimo-pct"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Porcentaje de pago m√≠nimo (%)
          </label>
          <input
            type="number"
            id="pago-minimo-pct"
            placeholder="Ej: 5"
            min="1"
            max="50"
            step="0.5"
            value="5"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            El pago m√≠nimo var√≠a por banco, generalmente entre 3% y 10% del
            saldo.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="pago-fijo"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            O bien, pago mensual fijo ($) ‚Äî opcional
          </label>
          <input
            type="number"
            id="pago-fijo"
            placeholder="Ej: 80.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Si ingresas un monto fijo, se usa en lugar del porcentaje m√≠nimo.
          </p>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular costo real ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üí∏ Resultado</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">üí≥</p>
          <p class="text-sm">Ingresa tu deuda y presiona calcular.</p>
        </div>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øPor qu√© el pago m√≠nimo es tan costoso?</h2>
      <p>
        Cuando pagas solo el m√≠nimo de tu tarjeta, la mayor parte de ese dinero
        cubre los intereses del mes ‚Äî no la deuda. El saldo baja muy lentamente,
        y los intereses se calculan sobre ese saldo cada mes. El efecto es que
        terminas pagando el doble o el triple del valor original.
      </p>
      <ul>
        <li>
          <strong>Tasa m√°xima convencional (TMC):</strong> Es el m√°ximo legal que
          puede cobrar una tarjeta. Para cr√©ditos de consumo hasta 200 UF es de aproximadamente
          3.49% mensual (equivalente a m√°s de 50% anual).
        </li>
        <li>
          <strong>Inter√©s sobre saldo:</strong> Los intereses se calculan sobre lo
          que debes cada mes, no sobre el monto original.
        </li>
        <li>
          <strong>La soluci√≥n:</strong> Pagar siempre m√°s del m√≠nimo, o usar el excedente
          de otros meses para abonar al capital.
        </li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Valores referenciales. La simulaci√≥n asume cuotas constantes. Las TMC
        reales var√≠an por banco y tipo de operaci√≥n ‚Äî verifica en la <a
          href="https://www.cmfchile.cl"
          target="_blank">CMF</a
        >.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { simulateCreditCardCost } from "@/application/use-cases/SimulateCreditCardCost";

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const deuda =
      parseFloat(
        (document.getElementById("deuda") as HTMLInputElement).value
      ) || 0;
    const tasaMensual =
      parseFloat((document.getElementById("tasa") as HTMLInputElement).value) /
      100;
    const pctMinimo =
      parseFloat(
        (document.getElementById("pago-minimo-pct") as HTMLInputElement).value
      ) / 100;
    const pagoFijo =
      parseFloat(
        (document.getElementById("pago-fijo") as HTMLInputElement).value
      ) || 0;

    if (deuda <= 0) {
      alert("Por favor ingresa una deuda v√°lida.");
      return;
    }

    let simulacion;
    try {
      simulacion = simulateCreditCardCost({
        debt: deuda,
        monthlyRatePercent: tasaMensual * 100,
        minimumPaymentPercent: pctMinimo * 100,
        fixedMonthlyPayment: pagoFijo > 0 ? pagoFijo : undefined,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo simular la tarjeta de cr√©dito."
      );
      return;
    }

    const resultado = simulacion.baseline;
    const resultadoDoble = simulacion.doubledPayment;
    const primerasCuotas = resultado.firstMonthlyPayments;

    const a√±os = Math.floor(resultado.months / 12);
    const mesesRest = resultado.months % 12;
    const tiempoStr =
      a√±os > 0
        ? `${a√±os} a√±o${a√±os > 1 ? "s" : ""} y ${mesesRest} meses`
        : `${resultado.months} meses`;

    const a√±osDoble = Math.floor(resultadoDoble.months / 12);
    const mesesDoble = resultadoDoble.months % 12;
    const tiempoDobleStr =
      a√±osDoble > 0
        ? `${a√±osDoble} a√±o${a√±osDoble > 1 ? "s" : ""} y ${mesesDoble} meses`
        : `${resultadoDoble.months} meses`;

    const buildRow = (label: string, value: string, colorClass = "") => {
      const line = document.createElement("div");
      line.className =
        "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

      const labelElement = document.createElement("span");
      labelElement.className = "text-foreground/60";
      labelElement.textContent = label;

      const valueElement = document.createElement("span");
      valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
      valueElement.textContent = value;

      line.append(labelElement, valueElement);
      return line;
    };

    const headline = document.createElement("div");
    headline.className =
      "mb-5 rounded-lg border border-red-500/20 bg-red-500/10 p-4 text-center";
    const headlineLabel = document.createElement("p");
    headlineLabel.className =
      "mb-1 text-xs font-bold tracking-widest text-red-400 uppercase";
    headlineLabel.textContent = `Total a pagar (con ${
      simulacion.usesFixedPayment ? "cuota fija" : "pago m√≠nimo"
    })`;
    const headlineValue = document.createElement("p");
    headlineValue.className = "text-4xl font-bold";
    headlineValue.textContent = fmt(resultado.totalPaid);
    const originalDebt = document.createElement("p");
    originalDebt.className = "mt-1 text-sm text-foreground/50";
    originalDebt.textContent = `Deuda original: ${fmt(deuda)}`;
    headline.append(headlineLabel, headlineValue, originalDebt);

    const firstPaymentsBox = document.createElement("div");
    firstPaymentsBox.className = "mt-4 rounded-lg bg-foreground/5 p-3";
    const firstPaymentsLabel = document.createElement("p");
    firstPaymentsLabel.className =
      "mb-2 text-xs font-bold text-foreground/50 uppercase";
    firstPaymentsLabel.textContent = "Primeras cuotas estimadas";
    firstPaymentsBox.appendChild(firstPaymentsLabel);
    for (const [index, payment] of primerasCuotas.entries()) {
      firstPaymentsBox.appendChild(buildRow(`Mes ${index + 1}`, fmt(payment)));
    }

    const doublePaymentBox = document.createElement("div");
    doublePaymentBox.className =
      "mt-5 rounded-lg border border-green-500/30 bg-green-500/5 p-4";
    const doublePaymentLabel = document.createElement("p");
    doublePaymentLabel.className =
      "mb-2 text-xs font-bold text-green-500 uppercase";
    doublePaymentLabel.textContent = "‚úì Si pagas el doble cada mes";
    doublePaymentBox.append(
      doublePaymentLabel,
      buildRow("Total a pagar", fmt(resultadoDoble.totalPaid)),
      buildRow("Intereses", fmt(resultadoDoble.totalInterest)),
      buildRow("Tiempo", tiempoDobleStr),
      buildRow(
        "Ahorro vs m√≠nimo",
        fmt(resultado.totalPaid - resultadoDoble.totalPaid),
        "text-green-500"
      )
    );

    document
      .getElementById("resultado-contenido")!
      .replaceChildren(
        headline,
        buildRow(
          "Intereses totales",
          fmt(resultado.totalInterest),
          "text-red-400"
        ),
        buildRow("Tiempo para saldar", tiempoStr, "text-red-400"),
        buildRow(
          "Factor de costo",
          `√ó${(resultado.totalPaid / deuda).toFixed(2)}`
        ),
        ...(primerasCuotas.length > 0 ? [firstPaymentsBox] : []),
        doublePaymentBox
      );
  });
</script>
