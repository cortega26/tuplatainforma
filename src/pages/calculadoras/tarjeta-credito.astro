---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Costo Real de Tarjeta de Cr√©dito | Pago M√≠nimo"
  description="Simula cu√°nto pagas en intereses y tiempo al cubrir pago m√≠nimo o cuota fija de tarjeta de cr√©dito."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üí≥ Costo Real de la Tarjeta de Cr√©dito
      </h1>
      <p class="max-w-xl text-foreground/70">
        Descubre cu√°nto pagas realmente si solo abonas el m√≠nimo de tu tarjeta. Ve el costo total en tiempo e intereses.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Datos de tu deuda</h2>

        <div class="mb-4">
          <label for="deuda" class="mb-1 block text-sm font-medium text-foreground/70">
            Deuda actual ($)
          </label>
          <input
            type="number" id="deuda" placeholder="Ej: 500.000" min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label for="tasa" class="mb-1 block text-sm font-medium text-foreground/70">
            Tasa de inter√©s mensual (%)
          </label>
          <input
            type="number" id="tasa" placeholder="Ej: 3.5" min="0" max="10" step="0.01" value="3.49"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            La TMC (tasa m√°xima convencional) vigente en 2026 para tarjetas es ~3.49% mensual. Revisa tu contrato para el valor exacto.
          </p>
        </div>

        <div class="mb-4">
          <label for="pago-minimo-pct" class="mb-1 block text-sm font-medium text-foreground/70">
            Porcentaje de pago m√≠nimo (%)
          </label>
          <input
            type="number" id="pago-minimo-pct" placeholder="Ej: 5" min="1" max="50" step="0.5" value="5"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            El pago m√≠nimo var√≠a por banco, generalmente entre 3% y 10% del saldo.
          </p>
        </div>

        <div class="mb-4">
          <label for="pago-fijo" class="mb-1 block text-sm font-medium text-foreground/70">
            O bien, pago mensual fijo ($) ‚Äî opcional
          </label>
          <input
            type="number" id="pago-fijo" placeholder="Ej: 80.000" min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Si ingresas un monto fijo, se usa en lugar del porcentaje m√≠nimo.
          </p>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Calcular costo real ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div id="resultado" class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üí∏ Resultado</h2>
        <div id="resultado-contenido" class="py-8 text-center text-foreground/40">
          <p class="mb-3 text-4xl">üí≥</p>
          <p class="text-sm">Ingresa tu deuda y presiona calcular.</p>
        </div>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert">
      <h2>¬øPor qu√© el pago m√≠nimo es tan costoso?</h2>
      <p>
        Cuando pagas solo el m√≠nimo de tu tarjeta, la mayor parte de ese dinero cubre los intereses del mes ‚Äî no la deuda. El saldo baja muy lentamente, y los intereses se calculan sobre ese saldo cada mes. El efecto es que terminas pagando el doble o el triple del valor original.
      </p>
      <ul>
        <li><strong>Tasa m√°xima convencional (TMC):</strong> Es el m√°ximo legal que puede cobrar una tarjeta. En 2026, para cr√©ditos de consumo hasta 200 UF es de aproximadamente 3.49% mensual (equivalente a m√°s de 50% anual).</li>
        <li><strong>Inter√©s sobre saldo:</strong> Los intereses se calculan sobre lo que debes cada mes, no sobre el monto original.</li>
        <li><strong>La soluci√≥n:</strong> Pagar siempre m√°s del m√≠nimo, o usar el excedente de otros meses para abonar al capital.</li>
      </ul>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Valores referenciales. La simulaci√≥n asume cuotas constantes. Las TMC reales var√≠an por banco y tipo de operaci√≥n ‚Äî verifica en la <a href="https://www.cmfchile.cl" target="_blank">CMF</a>.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function simular(deuda: number, tasaMensual: number, pagoFn: (saldo: number) => number, maxMeses = 600) {
    let saldo = deuda;
    let totalPagado = 0;
    let meses = 0;
    const pagos: number[] = [];

    while (saldo > 100 && meses < maxMeses) {
      const interes = saldo * tasaMensual;
      const pago = Math.max(pagoFn(saldo), interes + 100); // al menos cubre inter√©s + algo
      const pagoReal = Math.min(pago, saldo + interes);
      saldo = saldo + interes - pagoReal;
      totalPagado += pagoReal;
      meses++;
      if (meses <= 6) pagos.push(pagoReal);
    }

    return { meses, totalPagado, totalIntereses: totalPagado - deuda, pagos };
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const deuda = parseFloat((document.getElementById("deuda") as HTMLInputElement).value) || 0;
    const tasaMensual = parseFloat((document.getElementById("tasa") as HTMLInputElement).value) / 100;
    const pctMinimo = parseFloat((document.getElementById("pago-minimo-pct") as HTMLInputElement).value) / 100;
    const pagoFijo = parseFloat((document.getElementById("pago-fijo") as HTMLInputElement).value) || 0;

    if (deuda <= 0) {
      alert("Por favor ingresa una deuda v√°lida.");
      return;
    }

    const usarFijo = pagoFijo > 0;
    const pagoFn = usarFijo
      ? (_: number) => pagoFijo
      : (saldo: number) => saldo * pctMinimo;

    const resultado = simular(deuda, tasaMensual, pagoFn);
    const primerasCuotas = resultado.pagos;

    // Escenario "pago doble" para comparar
    const pagoFnDoble = usarFijo
      ? (_: number) => pagoFijo * 2
      : (saldo: number) => saldo * pctMinimo * 2;
    const resultadoDoble = simular(deuda, tasaMensual, pagoFnDoble);

    const a√±os = Math.floor(resultado.meses / 12);
    const mesesRest = resultado.meses % 12;
    const tiempoStr = a√±os > 0 ? `${a√±os} a√±o${a√±os > 1 ? "s" : ""} y ${mesesRest} meses` : `${resultado.meses} meses`;

    const a√±osDoble = Math.floor(resultadoDoble.meses / 12);
    const mesesDoble = resultadoDoble.meses % 12;
    const tiempoDobleStr = a√±osDoble > 0 ? `${a√±osDoble} a√±o${a√±osDoble > 1 ? "s" : ""} y ${mesesDoble} meses` : `${resultadoDoble.meses} meses`;

    const row = (label: string, value: string, color = "") =>
      `<div class="flex justify-between items-center py-2 border-b border-border text-sm last:border-0">
        <span class="text-foreground/60">${label}</span>
        <span class="font-semibold font-mono ${color}">${value}</span>
      </div>`;

    const primerosPagosHtml = primerasCuotas.length > 0
      ? `<div class="mt-4 rounded-lg bg-foreground/5 p-3">
          <p class="text-xs font-bold text-foreground/50 uppercase mb-2">Primeras cuotas estimadas</p>
          ${primerasCuotas.map((p, i) => row(`Mes ${i + 1}`, fmt(p))).join("")}
         </div>`
      : "";

    document.getElementById("resultado-contenido")!.innerHTML = `
      <div class="text-center mb-5 p-4 rounded-lg bg-red-500/10 border border-red-500/20">
        <p class="text-xs font-bold uppercase tracking-widest text-red-400 mb-1">Total a pagar (con ${usarFijo ? "cuota fija" : "pago m√≠nimo"})</p>
        <p class="text-4xl font-bold">${fmt(resultado.totalPagado)}</p>
        <p class="text-sm text-foreground/50 mt-1">Deuda original: ${fmt(deuda)}</p>
      </div>

      ${row("Intereses totales", fmt(resultado.totalIntereses), "text-red-400")}
      ${row("Tiempo para saldar", tiempoStr, "text-red-400")}
      ${row("Factor de costo", `√ó${(resultado.totalPagado / deuda).toFixed(2)}`)}

      ${primerosPagosHtml}

      <div class="mt-5 rounded-lg border border-green-500/30 bg-green-500/5 p-4">
        <p class="text-xs font-bold text-green-500 uppercase mb-2">‚úì Si pagas el doble cada mes</p>
        ${row("Total a pagar", fmt(resultadoDoble.totalPagado))}
        ${row("Intereses", fmt(resultadoDoble.totalIntereses))}
        ${row("Tiempo", tiempoDobleStr)}
        ${row("Ahorro vs m√≠nimo", fmt(resultado.totalPagado - resultadoDoble.totalPagado), "text-green-500")}
      </div>
    `;
  });
</script>
