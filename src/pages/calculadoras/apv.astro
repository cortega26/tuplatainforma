---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Simulador APV Chile | R√©gimen A vs B"
  description="Compara el ahorro tributario de APV en R√©gimen A y B seg√∫n tu sueldo y aporte mensual."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üìà Simulador APV
      </h1>
      <p class="max-w-xl text-foreground/70">
        Calcula cu√°nto ahorras en impuestos con el APV R√©gimen A o B seg√∫n tu sueldo. Compara ambos reg√≠menes y encuentra cu√°l te conviene.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Ingresa tus datos</h2>

        <div class="mb-4">
          <label for="sueldo" class="mb-1 block text-sm font-medium text-foreground/70">
            Sueldo bruto mensual ($)
          </label>
          <input
            type="number"
            id="sueldo"
            placeholder="Ej: 1.500.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label for="ahorro" class="mb-1 block text-sm font-medium text-foreground/70">
            Ahorro APV mensual ($)
          </label>
          <input
            type="number"
            id="ahorro"
            placeholder="Ej: 100.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Para recibir el bono m√°ximo del R√©gimen A necesitas ahorrar al menos ~$224.000/mes (‚âà 40 UTM / 12).
          </p>
        </div>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-foreground/70">Sistema de salud</label>
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="salud" value="fonasa" checked class="peer sr-only" />
              <span class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent">
                Fonasa (7%)
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input type="radio" name="salud" value="isapre" class="peer sr-only" />
              <span class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent">
                Isapre (7%+)
              </span>
            </label>
          </div>
        </div>

        <div id="isapre-field" class="mb-4 hidden">
          <label for="isapre-adicional" class="mb-1 block text-sm font-medium text-foreground/70">
            Cotizaci√≥n adicional Isapre (%)
          </label>
          <input
            type="number"
            id="isapre-adicional"
            placeholder="Ej: 2.5"
            min="0" max="20" step="0.1" value="2"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label for="afp-tasa" class="mb-1 block text-sm font-medium text-foreground/70">AFP</label>
          <select id="afp-tasa" class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none">
            <option value="10.58">Capital ‚Äì 10.58%</option>
            <option value="10.65">Cuprum ‚Äì 10.65%</option>
            <option value="10.77" selected>Habitat ‚Äì 10.77%</option>
            <option value="10.58">Modelo ‚Äì 10.58%</option>
            <option value="10.49">PlanVital ‚Äì 10.49%</option>
            <option value="10.69">ProVida ‚Äì 10.69%</option>
            <option value="10.46">Uno ‚Äì 10.46%</option>
          </select>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Comparar R√©gimen A vs B ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div id="resultado" class="rounded-xl border border-border bg-background p-6">
        <h2 class="mb-5 text-lg font-semibold">üí° Comparaci√≥n de reg√≠menes</h2>
        <div id="resultado-contenido" class="py-8 text-center text-foreground/40">
          <p class="mb-3 text-4xl">üìä</p>
          <p class="text-sm">Ingresa tus datos y presiona comparar.</p>
        </div>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert">
      <h2>¬øQu√© es el APV y c√≥mo funciona el beneficio?</h2>
      <p>
        El APV (Ahorro Previsional Voluntario) es un mecanismo legal para reducir impuestos mientras ahorras para tu pensi√≥n. Debes elegir entre dos reg√≠menes:
      </p>
      <ul>
        <li><strong>R√©gimen A:</strong> El Estado te deposita directamente un bono del 15% de lo que ahorraste, con tope de 6 UTM anuales (~$402.000). Ideal si tu sueldo es menor a $4.800.000.</li>
        <li><strong>R√©gimen B:</strong> Tus aportes se descuentan de tu base imponible, reduciendo el impuesto que pagas cada mes. Ideal si est√°s en tramos altos de impuesto (23%+).</li>
      </ul>
      <p>
        Si retiras antes de jubilar, en R√©gimen A devuelves el bono; en R√©gimen B pagas impuesto diferido m√°s una sobretasa. El APV es un instrumento de largo plazo.
      </p>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Valores referenciales. UTM usada: $67.294 (enero 2026). Para informaci√≥n oficial visita la <a href="https://www.spensiones.cl" target="_blank">Superintendencia de Pensiones</a> y el <a href="https://www.sii.cl" target="_blank">SII</a>.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  const UTM = 67294;
  const UF = 38576; // valor referencial enero 2026

  const TRAMOS = [
    { hasta: 13.5 * UTM, tasa: 0, rebaja: 0 },
    { hasta: 30 * UTM, tasa: 0.04, rebaja: 13.5 * UTM * 0.04 },
    { hasta: 50 * UTM, tasa: 0.08, rebaja: 30 * UTM * (0.08 - 0.04) + 13.5 * UTM * 0.04 },
    { hasta: 70 * UTM, tasa: 0.135, rebaja: 50 * UTM * (0.135 - 0.08) + 30 * UTM * 0.04 },
    { hasta: 90 * UTM, tasa: 0.23, rebaja: 70 * UTM * (0.23 - 0.135) + 50 * UTM * 0.08 },
    { hasta: 120 * UTM, tasa: 0.304, rebaja: 90 * UTM * (0.304 - 0.23) + 70 * UTM * 0.135 },
    { hasta: 150 * UTM, tasa: 0.35, rebaja: 120 * UTM * (0.35 - 0.304) + 90 * UTM * 0.23 },
    { hasta: Infinity, tasa: 0.4, rebaja: 150 * UTM * (0.4 - 0.35) + 120 * UTM * 0.304 },
  ];

  function calcularImpuesto(base: number): number {
    for (const tramo of TRAMOS) {
      if (base <= tramo.hasta) return Math.max(0, base * tramo.tasa - tramo.rebaja);
    }
    return 0;
  }

  function tasaMarginal(base: number): number {
    for (const tramo of TRAMOS) {
      if (base <= tramo.hasta) return tramo.tasa;
    }
    return 0.4;
  }

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtPct(n: number): string {
    return (n * 100).toFixed(1) + "%";
  }

  document.querySelectorAll("input[name='salud']").forEach(radio => {
    radio.addEventListener("change", () => {
      const isIsapre = (document.querySelector("input[name='salud']:checked") as HTMLInputElement)?.value === "isapre";
      document.getElementById("isapre-field")?.classList.toggle("hidden", !isIsapre);
    });
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const bruto = parseFloat((document.getElementById("sueldo") as HTMLInputElement).value) || 0;
    const ahorro = parseFloat((document.getElementById("ahorro") as HTMLInputElement).value) || 0;

    if (bruto <= 0 || ahorro <= 0) {
      alert("Por favor ingresa sueldo y monto de ahorro APV.");
      return;
    }

    const afpTasa = parseFloat((document.getElementById("afp-tasa") as HTMLSelectElement).value) / 100;
    const isIsapre = (document.querySelector("input[name='salud']:checked") as HTMLInputElement)?.value === "isapre";
    const isapreadicional = parseFloat((document.getElementById("isapre-adicional") as HTMLInputElement).value) || 0;
    const saludTasa = 0.07 + (isIsapre ? isapreadicional / 100 : 0);

    const descAfp = bruto * afpTasa;
    const descSalud = bruto * saludTasa;
    const baseImpuesto = bruto - descAfp - descSalud;

    // Sin APV
    const impSinApv = calcularImpuesto(baseImpuesto);

    // R√©gimen A: no cambia el impuesto mensual, pero el Estado aporta 15% del ahorro (tope 6 UTM)
    const bonoAnual = Math.min(ahorro * 12 * 0.15, 6 * UTM);
    const bonoMensual = bonoAnual / 12;
    const impConA = impSinApv; // impuesto no cambia
    const beneficioMensualA = bonoMensual;

    // R√©gimen B: el ahorro se descuenta de la base imponible
    const ahorroEfectivo = Math.min(ahorro, 50 * UF / 12); // tope mensual 50 UF
    const baseConB = Math.max(0, baseImpuesto - ahorroEfectivo);
    const impConB = calcularImpuesto(baseConB);
    const beneficioMensualB = impSinApv - impConB;

    const tasa = tasaMarginal(baseImpuesto);
    const recomendacion = beneficioMensualA >= beneficioMensualB ? "A" : "B";

    const card = (titulo: string, color: string, items: string[], recomendado = false) => `
      <div class="rounded-lg border ${recomendado ? "border-accent bg-accent/5" : "border-border"} p-4 mb-4">
        ${recomendado ? '<p class="text-xs font-bold text-accent uppercase tracking-widest mb-2">‚úì Recomendado para ti</p>' : ""}
        <h3 class="font-bold text-base mb-3 ${color}">${titulo}</h3>
        ${items.map(i => `<div class="flex justify-between text-sm py-1.5 border-b border-border last:border-0"><span class="text-foreground/60">${i.split("|")[0]}</span><span class="font-semibold font-mono">${i.split("|")[1]}</span></div>`).join("")}
      </div>`;

    document.getElementById("resultado-contenido")!.innerHTML = `
      <div class="mb-4 rounded-lg bg-foreground/5 p-3 text-sm text-foreground/70">
        <strong>Tu tasa marginal de impuesto:</strong> ${fmtPct(tasa)}<br>
        <strong>Impuesto sin APV:</strong> ${fmt(impSinApv)}/mes
      </div>

      ${card("R√©gimen A ‚Äî Bono del Estado", "text-blue-500",
        [
          `Impuesto mensual|${fmt(impConA)}`,
          `Bono Estado (15%)|+ ${fmt(beneficioMensualA)}/mes`,
          `Bono anual estimado|+ ${fmt(bonoAnual)}`,
          `Beneficio mensual neto|${fmt(beneficioMensualA)}`,
        ],
        recomendacion === "A"
      )}

      ${card("R√©gimen B ‚Äî Rebaja de impuesto", "text-green-500",
        [
          `Base imponible reducida|${fmt(baseConB)}`,
          `Impuesto con APV|${fmt(impConB)}`,
          `Ahorro impuesto mensual|${fmt(beneficioMensualB)}`,
          `Ahorro impuesto anual|${fmt(beneficioMensualB * 12)}`,
        ],
        recomendacion === "B"
      )}

      <p class="text-xs text-foreground/40 mt-2">El bono del R√©gimen A se acredita en tu cuenta APV al a√±o siguiente (Operaci√≥n Renta). El tope mensual de aporte con beneficio en R√©gimen B es 50 UF (~${fmt(50 * UF / 12)}).</p>
    `;
  });
</script>
