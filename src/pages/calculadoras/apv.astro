---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import { getEconomicParameters } from "@/application/use-cases/GetEconomicParameters";

const { parameters: economicParameters } = await getEconomicParameters();
const formatCurrency = (value: number) =>
  "$" + Math.round(value).toLocaleString("es-CL");
const monthlyRegimeATarget = (40 * economicParameters.utm) / 12;
const annualRegimeABonusCap = 6 * economicParameters.utm;
const economicSourceLabel =
  economicParameters.source === "live"
    ? "dato en l√≠nea"
    : "fallback controlado";
---

<Layout
  title="Simulador APV Chile | R√©gimen A vs B"
  description="Compara el ahorro tributario de APV en R√©gimen A y B seg√∫n tu sueldo y aporte mensual."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">üìà Simulador APV</h1>
      <p class="max-w-xl text-foreground/70">
        Calcula cu√°nto ahorras en impuestos con el APV R√©gimen A o B seg√∫n tu
        sueldo. Compara ambos reg√≠menes y encuentra cu√°l te conviene.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Ingresa tus datos</h2>

        <div class="mb-4">
          <label
            for="sueldo"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Sueldo bruto mensual ($)
          </label>
          <input
            type="number"
            id="sueldo"
            placeholder="Ej: 1.500.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="ahorro"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Ahorro APV mensual ($)
          </label>
          <input
            type="number"
            id="ahorro"
            placeholder="Ej: 100.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-foreground/50">
            Para recibir el bono m√°ximo del R√©gimen A necesitas ahorrar al menos
            ~{formatCurrency(monthlyRegimeATarget)}/mes (‚âà 40 UTM / 12).
          </p>
        </div>

        <div class="mb-4">
          <label class="mb-2 block text-sm font-medium text-foreground/70"
            >Sistema de salud</label
          >
          <div class="flex gap-2">
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="salud"
                value="fonasa"
                checked
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Fonasa (7%)
              </span>
            </label>
            <label class="flex-1 cursor-pointer">
              <input
                type="radio"
                name="salud"
                value="isapre"
                class="peer sr-only"
              />
              <span
                class="block rounded-lg border border-border px-3 py-2 text-center text-sm font-medium transition-all peer-checked:border-accent peer-checked:text-accent"
              >
                Isapre (7%+)
              </span>
            </label>
          </div>
        </div>

        <div id="isapre-field" class="mb-4 hidden">
          <label
            for="isapre-adicional"
            class="mb-1 block text-sm font-medium text-foreground/70"
          >
            Cotizaci√≥n adicional Isapre (%)
          </label>
          <input
            type="number"
            id="isapre-adicional"
            placeholder="Ej: 2.5"
            min="0"
            max="20"
            step="0.1"
            value="2"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="afp-tasa"
            class="mb-1 block text-sm font-medium text-foreground/70">AFP</label
          >
          <select
            id="afp-tasa"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          >
            <option value="10.58">Capital ‚Äì 10.58%</option>
            <option value="10.65">Cuprum ‚Äì 10.65%</option>
            <option value="10.77" selected>Habitat ‚Äì 10.77%</option>
            <option value="10.58">Modelo ‚Äì 10.58%</option>
            <option value="10.49">PlanVital ‚Äì 10.49%</option>
            <option value="10.69">ProVida ‚Äì 10.69%</option>
            <option value="10.46">Uno ‚Äì 10.46%</option>
          </select>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Comparar R√©gimen A vs B ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üí° Comparaci√≥n de reg√≠menes</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-foreground/40"
        >
          <p class="mb-3 text-4xl">üìä</p>
          <p class="text-sm">Ingresa tus datos y presiona comparar.</p>
        </div>
        <div
          id="economic-parameters"
          data-utm={String(economicParameters.utm)}
          data-uf={String(economicParameters.uf)}
          class="hidden"
          aria-hidden="true"
        >
        </div>
        <p class="mt-3 text-xs text-foreground/40">
          Fuente econ√≥mica: {economicSourceLabel} ({
            economicParameters.lastUpdated
          }).
        </p>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øQu√© es el APV y c√≥mo funciona el beneficio?</h2>
      <p>
        El APV (Ahorro Previsional Voluntario) es un mecanismo legal para
        reducir impuestos mientras ahorras para tu pensi√≥n. Debes elegir entre
        dos reg√≠menes:
      </p>
      <ul>
        <li>
          <strong>R√©gimen A:</strong> El Estado te deposita directamente un bono del
          15% de lo que ahorraste, con tope de 6 UTM anuales (~{
            formatCurrency(annualRegimeABonusCap)
          }).
        </li>
        <li>
          <strong>R√©gimen B:</strong> Tus aportes se descuentan de tu base imponible,
          reduciendo el impuesto que pagas cada mes. Ideal si est√°s en tramos altos
          de impuesto (23%+).
        </li>
      </ul>
      <p>
        Si retiras antes de jubilar, en R√©gimen A devuelves el bono; en R√©gimen
        B pagas impuesto diferido m√°s una sobretasa. El APV es un instrumento de
        largo plazo.
      </p>
      <p class="text-sm text-foreground/50">
        ‚ö†Ô∏è Valores referenciales. Par√°metros econ√≥micos vigentes al momento del
        build. Para informaci√≥n oficial visita la <a
          href="https://www.spensiones.cl"
          target="_blank">Superintendencia de Pensiones</a
        > y el <a href="https://www.sii.cl" target="_blank">SII</a>.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { calculateApvComparison } from "@/application/use-cases/CalculateApvComparison";

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtPct(n: number): string {
    return (n * 100).toFixed(1) + "%";
  }

  function readEconomicParameters(): { uf: number; utm: number } {
    const element = document.getElementById("economic-parameters");
    const uf = Number(element?.dataset?.uf);
    const utm = Number(element?.dataset?.utm);
    if (!Number.isFinite(uf) || uf <= 0 || !Number.isFinite(utm) || utm <= 0) {
      throw new Error("No se pudieron cargar los par√°metros econ√≥micos.");
    }
    return { uf, utm };
  }

  const economicParameters = readEconomicParameters();

  document.querySelectorAll("input[name='salud']").forEach(radio => {
    radio.addEventListener("change", () => {
      const isIsapre =
        (
          document.querySelector(
            "input[name='salud']:checked"
          ) as HTMLInputElement
        )?.value === "isapre";
      document
        .getElementById("isapre-field")
        ?.classList.toggle("hidden", !isIsapre);
    });
  });

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const bruto =
      parseFloat(
        (document.getElementById("sueldo") as HTMLInputElement).value
      ) || 0;
    const ahorro =
      parseFloat(
        (document.getElementById("ahorro") as HTMLInputElement).value
      ) || 0;

    if (bruto <= 0 || ahorro <= 0) {
      alert("Por favor ingresa sueldo y monto de ahorro APV.");
      return;
    }

    const afpTasaPercent = parseFloat(
      (document.getElementById("afp-tasa") as HTMLSelectElement).value
    );
    const healthSystem =
      (
        document.querySelector(
          "input[name='salud']:checked"
        ) as HTMLInputElement
      )?.value === "isapre"
        ? "isapre"
        : "fonasa";
    const isapreAdicionalPercent =
      parseFloat(
        (document.getElementById("isapre-adicional") as HTMLInputElement).value
      ) || 0;

    let resultado;
    try {
      resultado = calculateApvComparison({
        grossSalary: bruto,
        monthlyApvContribution: ahorro,
        afpRatePercent: afpTasaPercent,
        healthSystem,
        isapreAdditionalPercent: isapreAdicionalPercent,
        economicParameters,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo calcular la comparaci√≥n APV."
      );
      return;
    }

    const buildCard = (
      title: string,
      colorClass: string,
      items: Array<{ label: string; value: string }>,
      recommended = false
    ): HTMLDivElement => {
      const card = document.createElement("div");
      card.className = `mb-4 rounded-lg border p-4 ${
        recommended ? "border-accent bg-accent/5" : "border-border"
      }`;

      if (recommended) {
        const badge = document.createElement("p");
        badge.className =
          "mb-2 text-xs font-bold tracking-widest text-accent uppercase";
        badge.textContent = "‚úì Recomendado para ti";
        card.appendChild(badge);
      }

      const titleElement = document.createElement("h3");
      titleElement.className = `mb-3 text-base font-bold ${colorClass}`;
      titleElement.textContent = title;
      card.appendChild(titleElement);

      for (const item of items) {
        const line = document.createElement("div");
        line.className =
          "flex justify-between border-b border-border py-1.5 text-sm last:border-0";

        const labelElement = document.createElement("span");
        labelElement.className = "text-foreground/60";
        labelElement.textContent = item.label;

        const valueElement = document.createElement("span");
        valueElement.className = "font-mono font-semibold";
        valueElement.textContent = item.value;

        line.append(labelElement, valueElement);
        card.appendChild(line);
      }

      return card;
    };

    const summary = document.createElement("div");
    summary.className =
      "mb-4 rounded-lg bg-foreground/5 p-3 text-sm text-foreground/70";
    const marginalText = document.createElement("p");
    const marginalStrong = document.createElement("strong");
    marginalStrong.textContent = "Tu tasa marginal de impuesto:";
    marginalText.append(marginalStrong, ` ${fmtPct(resultado.marginalRate)}`);
    const taxText = document.createElement("p");
    const taxStrong = document.createElement("strong");
    taxStrong.textContent = "Impuesto sin APV:";
    taxText.append(taxStrong, ` ${fmt(resultado.taxWithoutApv)}/mes`);
    summary.append(marginalText, taxText);

    const regimeACard = buildCard(
      "R√©gimen A ‚Äî Bono del Estado",
      "text-blue-500",
      [
        { label: "Impuesto mensual", value: fmt(resultado.regimeA.monthlyTax) },
        {
          label: "Bono Estado (15%)",
          value: `+ ${fmt(resultado.regimeA.monthlyBenefit)}/mes`,
        },
        {
          label: "Bono anual estimado",
          value: `+ ${fmt(resultado.regimeA.annualBonus)}`,
        },
        {
          label: "Beneficio mensual neto",
          value: fmt(resultado.regimeA.monthlyBenefit),
        },
      ],
      resultado.recommendedRegime === "A"
    );

    const regimeBCard = buildCard(
      "R√©gimen B ‚Äî Rebaja de impuesto",
      "text-green-500",
      [
        {
          label: "Base imponible reducida",
          value: fmt(resultado.regimeB.reducedTaxBase),
        },
        { label: "Impuesto con APV", value: fmt(resultado.regimeB.monthlyTax) },
        {
          label: "Ahorro impuesto mensual",
          value: fmt(resultado.regimeB.monthlyBenefit),
        },
        {
          label: "Ahorro impuesto anual",
          value: fmt(resultado.regimeB.annualBenefit),
        },
      ],
      resultado.recommendedRegime === "B"
    );

    const note = document.createElement("p");
    note.className = "mt-2 text-xs text-foreground/40";
    note.textContent = `El bono del R√©gimen A se acredita en tu cuenta APV al a√±o siguiente (Operaci√≥n Renta). El tope mensual de aporte con beneficio en R√©gimen B es 50 UF (~${fmt(resultado.regimeB.monthlyContributionCap)}).`;

    document
      .getElementById("resultado-contenido")!
      .replaceChildren(summary, regimeACard, regimeBCard, note);
  });
</script>
