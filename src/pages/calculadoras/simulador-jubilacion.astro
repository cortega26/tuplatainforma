---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
---

<Layout
  title="Simulador de Jubilaci√≥n Chile | Proyecci√≥n AFP"
  description="Proyecta tu ahorro previsional y una pensi√≥n estimada seg√∫n sueldo, edad y rentabilidad esperada."
>
  <Header />
  <main id="main-content" class="app-layout">
    <section class="border-b border-border pt-8 pb-6">
      <h1 class="my-4 text-3xl font-bold sm:text-4xl">
        üèñÔ∏è Simulador de Jubilaci√≥n
      </h1>
      <p class="max-w-xl text-secondary">
        Estima cu√°nto acumular√°s en tu AFP al jubilar y qu√© pensi√≥n mensual
        podr√≠as esperar, seg√∫n tu sueldo y a√±os restantes.
      </p>
    </section>

    <section class="grid items-start gap-6 py-8 sm:grid-cols-2">
      <!-- FORMULARIO -->
      <div class="rounded-xl border border-border p-6">
        <h2 class="mb-5 text-lg font-semibold">üìù Tus datos</h2>

        <div class="mb-4">
          <label
            for="edad"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Edad actual (a√±os)
          </label>
          <input
            type="number"
            id="edad"
            placeholder="Ej: 35"
            min="18"
            max="64"
            value="35"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="edad-jubilacion"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Edad de jubilaci√≥n (a√±os)
          </label>
          <input
            type="number"
            id="edad-jubilacion"
            placeholder="Ej: 65"
            min="60"
            max="75"
            value="65"
            class="focus:invoke-none w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent"
          />
          <p class="mt-1 text-xs text-muted">
            Edad legal: 65 hombres, 60 mujeres (puede anticiparse).
          </p>
        </div>

        <div class="mb-4">
          <label
            for="sueldo"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Sueldo bruto mensual actual ($)
          </label>
          <input
            type="number"
            id="sueldo"
            placeholder="Ej: 1.200.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
        </div>

        <div class="mb-4">
          <label
            for="saldo-actual"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Saldo actual en AFP ($) ‚Äî opcional
          </label>
          <input
            type="number"
            id="saldo-actual"
            placeholder="Ej: 8.000.000"
            min="0"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            Consulta tu saldo en el sitio web de tu AFP.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="rentabilidad"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Rentabilidad anual esperada (%)
          </label>
          <select
            id="rentabilidad"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          >
            <option value="3">3% ‚Äî Conservadora (Fondos D/E)</option>
            <option value="5" selected>5% ‚Äî Moderada (Fondo C)</option>
            <option value="7">7% ‚Äî Agresiva (Fondos A/B)</option>
          </select>
          <p class="mt-1 text-xs text-muted">
            Rentabilidad real hist√≥rica promedio, descontada inflaci√≥n.
          </p>
        </div>

        <div class="mb-4">
          <label
            for="expectativa-vida"
            class="mb-1 block text-sm font-medium text-secondary"
          >
            Expectativa de vida estimada (a√±os)
          </label>
          <input
            type="number"
            id="expectativa-vida"
            placeholder="Ej: 85"
            min="65"
            max="100"
            value="85"
            class="w-full rounded-lg border border-border bg-background px-3 py-2 text-foreground focus:border-accent focus:outline-none"
          />
          <p class="mt-1 text-xs text-muted">
            Se usa para calcular cu√°ntos a√±os durar√° tu pensi√≥n.
          </p>
        </div>

        <button
          id="calcBtn"
          class="mt-2 w-full rounded-lg bg-accent px-4 py-3 text-base font-bold text-background transition-opacity hover:opacity-90"
        >
          Simular jubilaci√≥n ‚Üí
        </button>
      </div>

      <!-- RESULTADO -->
      <div
        id="resultado"
        class="rounded-xl border border-border bg-background p-6"
      >
        <h2 class="mb-5 text-lg font-semibold">üìä Proyecci√≥n</h2>
        <div
          id="resultado-contenido"
          class="py-8 text-center text-muted"
        >
          <p class="mb-3 text-4xl">üèñÔ∏è</p>
          <p class="text-sm">Ingresa tus datos y presiona simular.</p>
        </div>
      </div>
    </section>

    <!-- EXPLICACI√ìN -->
    <section
      class="prose prose-sm max-w-none border-t border-border pt-8 pb-12 dark:prose-invert"
    >
      <h2>¬øC√≥mo funciona la simulaci√≥n?</h2>
      <p>
        La calculadora proyecta el saldo acumulado en tu AFP al momento de
        jubilarte, considerando las cotizaciones mensuales del 10% de tu sueldo
        m√°s el aporte adicional del empleador contemplado en la Reforma
        Previsional vigente (que llega gradualmente al 7%).
      </p>
      <ul>
        <li>
          <strong>Cotizaci√≥n base:</strong> 10% de tu sueldo bruto cada mes.
        </li>
        <li>
          <strong>Aporte empleador (reforma vigente):</strong> Parte de este 7% adicional
          va directo a tu cuenta individual (4.5% del total). La simulaci√≥n lo incorpora
          de forma gradual durante el per√≠odo de implementaci√≥n.
        </li>
        <li>
          <strong>Rentabilidad:</strong> El fondo genera rentabilidad real sobre el
          saldo acumulado. La rentabilidad real hist√≥rica del sistema ha sido de entre
          4% y 7% anual en fondos medios.
        </li>
        <li>
          <strong>Pensi√≥n estimada:</strong> Se calcula dividiendo el saldo acumulado
          en los meses de vida restante desde la jubilaci√≥n, sin considerar rentabilidad
          posterior (estimaci√≥n conservadora).
        </li>
      </ul>
      <p class="text-sm text-muted">
        ‚ö†Ô∏è Esta es una simulaci√≥n educativa con supuestos simplificados. La
        pensi√≥n real depende de muchos factores adicionales: lagunas
        previsionales, modalidad de pensi√≥n, PGU, etc. Para una proyecci√≥n
        oficial consulta tu AFP o la <a
          href="https://www.spensiones.cl"
          target="_blank">Superintendencia de Pensiones</a
        >.
      </p>
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { simulateRetirementProjection } from "@/application/use-cases/SimulateRetirementProjection";

  function fmt(n: number): string {
    return "$" + Math.round(n).toLocaleString("es-CL");
  }

  function fmtM(n: number): string {
    if (n >= 1_000_000) return "$" + (n / 1_000_000).toFixed(1) + " millones";
    return fmt(n);
  }

  document.getElementById("calcBtn")?.addEventListener("click", () => {
    const edad =
      parseInt((document.getElementById("edad") as HTMLInputElement).value) ||
      35;
    const edadJubilacion =
      parseInt(
        (document.getElementById("edad-jubilacion") as HTMLInputElement).value
      ) || 65;
    const sueldo =
      parseFloat(
        (document.getElementById("sueldo") as HTMLInputElement).value
      ) || 0;
    const saldoInicial =
      parseFloat(
        (document.getElementById("saldo-actual") as HTMLInputElement).value
      ) || 0;
    const rentAnual =
      parseFloat(
        (document.getElementById("rentabilidad") as HTMLSelectElement).value
      ) / 100;
    const expectativaVida =
      parseInt(
        (document.getElementById("expectativa-vida") as HTMLInputElement).value
      ) || 85;

    if (sueldo <= 0) {
      alert("Por favor ingresa tu sueldo bruto mensual.");
      return;
    }

    const a√±osRestantes = Math.max(0, edadJubilacion - edad);
    if (a√±osRestantes <= 0) {
      alert("La edad de jubilaci√≥n debe ser mayor que tu edad actual.");
      return;
    }

    let proyeccion;
    try {
      proyeccion = simulateRetirementProjection({
        currentAge: edad,
        retirementAge: edadJubilacion,
        grossSalary: sueldo,
        currentBalance: saldoInicial,
        annualReturnPercent: rentAnual * 100,
        lifeExpectancyAge: expectativaVida,
      });
    } catch (error) {
      alert(
        error instanceof Error
          ? error.message
          : "No se pudo simular la jubilaci√≥n."
      );
      return;
    }

    const buildRow = (label: string, value: string, colorClass = "") => {
      const line = document.createElement("div");
      line.className =
        "flex items-center justify-between border-b border-border py-2 text-sm last:border-0";

      const labelElement = document.createElement("span");
      labelElement.className = "text-secondary";
      labelElement.textContent = label;

      const valueElement = document.createElement("span");
      valueElement.className = `font-mono font-semibold ${colorClass}`.trim();
      valueElement.textContent = value;

      line.append(labelElement, valueElement);
      return line;
    };

    const headline = document.createElement("div");
    headline.className =
      "mb-5 rounded-lg border border-accent/20 bg-accent/10 p-4 text-center";
    const headlineLabel = document.createElement("p");
    headlineLabel.className =
      "mb-1 text-xs font-bold tracking-widest text-accent uppercase";
    headlineLabel.textContent = "Saldo estimado al jubilar";
    const headlineValue = document.createElement("p");
    headlineValue.className = "text-4xl font-bold";
    headlineValue.textContent = fmtM(proyeccion.projectedBalance);
    const headlineSub = document.createElement("p");
    headlineSub.className = "mt-1 text-sm text-muted";
    headlineSub.textContent = `En ${a√±osRestantes} a√±os (a los ${edadJubilacion})`;
    headline.append(headlineLabel, headlineValue, headlineSub);

    const hint = document.createElement("div");
    hint.className =
      "mt-4 rounded-lg bg-foreground/5 p-3 text-xs text-secondary";
    const hintTitle = document.createElement("strong");
    hintTitle.textContent = "¬øQuieres mejorar esta proyecci√≥n?";
    hint.append(
      hintTitle,
      document.createElement("br"),
      `Agregar APV mensual aumenta significativamente el saldo final. Con $100.000/mes de APV durante ${a√±osRestantes} a√±os a ${
        rentAnual * 100
      }% anual, sumar√≠as aprox. ${fmtM(proyeccion.apvExtraProjectionAt100kMonthly)} adicionales al fondo.`
    );

    document
      .getElementById("resultado-contenido")!
      .replaceChildren(
        headline,
        buildRow(
          "Pensi√≥n mensual estimada",
          fmt(proyeccion.estimatedMonthlyPension),
          "text-accent"
        ),
        buildRow(
          "Como % de tu sueldo actual",
          `${proyeccion.salaryReplacementPercent.toFixed(0)}%`
        ),
        buildRow(
          "A√±os de pensi√≥n (vida estimada)",
          `${proyeccion.pensionMonths / 12} a√±os`
        ),
        buildRow("Rentabilidad anual usada", `${rentAnual * 100}%`),
        buildRow("Saldo inicial ingresado", fmt(saldoInicial)),
        hint
      );
  });
</script>
