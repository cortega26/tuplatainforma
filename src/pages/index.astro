---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import Datetime from "@/components/Datetime.astro";
import LinkButton from "@/components/LinkButton.astro";
import ArticlePlaceholder from "@/components/ArticlePlaceholder.astro";
import RevealOnScroll from "@/components/RevealOnScroll.astro";
import SectionDivider from "@/components/SectionDivider.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";
import { getPath } from "@/utils/getPath";
import { getCanonicalPathFromSlug } from "@/domain/content/path";
import { toArticleView } from "@/utils/articleView";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const heroPost = sortedPosts[0];
const heroArticle = heroPost ? toArticleView(heroPost) : null;
const secondaryPosts = sortedPosts
  .slice(1, 3)
  .map(post => ({ post, article: toArticleView(post) }));
const remainingPosts = sortedPosts.slice(3, 3 + SITE.postPerIndex);
const homePath = getPath("/");
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <!-- GRID EDITORIAL -->
    {
      heroPost && heroArticle && (
        <RevealOnScroll initialVisible={true}>
          <section class="grid gap-6 border-b border-border py-8 lg:grid-cols-3">
            <article class="lg:col-span-2">
              <a
                href={getCanonicalPathFromSlug(heroArticle.slug)}
                class="group block"
              >
                <div class="mb-4 overflow-hidden rounded-xl">
                  {(() => {
                    const heroImage =
                      typeof heroPost.data.ogImage === "string"
                        ? heroPost.data.ogImage
                        : heroPost.data.ogImage?.src;
                    return heroImage ? (
                      <img
                        src={heroImage}
                        alt={`Portada de ${heroPost.data.title}`}
                        width="1200"
                        height="675"
                        class="aspect-video w-full object-cover"
                        loading="eager"
                        fetchpriority="high"
                      />
                    ) : (
                      <ArticlePlaceholder tag={heroPost.data.tags?.[0]} />
                    );
                  })()}
                </div>
                <span class="mb-3 inline-block rounded-full bg-accent/10 px-3 py-1 text-xs font-semibold tracking-widest text-accent uppercase">
                  Destacado
                </span>
                <h1 class="mb-3 text-2xl leading-tight font-bold transition-colors group-hover:text-accent sm:text-4xl">
                  {heroPost.data.title}
                </h1>
                <p class="mb-4 max-w-3xl text-base leading-relaxed text-secondary">
                  {heroPost.data.description}
                </p>
                <div class="mb-4">
                  <Datetime
                    pubDatetime={heroArticle.pubDate}
                    modDatetime={heroArticle.updatedDate}
                    timezone={heroPost.data.timezone}
                  />
                </div>
                <span class="inline-flex items-center gap-1 text-sm font-semibold text-accent">
                  Leer art√≠culo <IconArrowRight class="inline-block" />
                </span>
              </a>
            </article>

            <div class="grid gap-6 lg:col-span-1">
              {secondaryPosts.map(({ post, article }) => {
                const secondaryImage =
                  typeof post.data.ogImage === "string"
                    ? post.data.ogImage
                    : post.data.ogImage?.src;
                return (
                  <article class="rounded-xl border border-border p-4">
                    <a
                      href={getCanonicalPathFromSlug(article.slug)}
                      class="group block transition-colors"
                    >
                      <div class="mb-3 overflow-hidden rounded-lg">
                        {secondaryImage ? (
                          <img
                            src={secondaryImage}
                            alt={`Portada de ${post.data.title}`}
                            width="1200"
                            height="675"
                            class="aspect-video w-full object-cover"
                            loading="lazy"
                            decoding="async"
                          />
                        ) : (
                          <ArticlePlaceholder tag={post.data.tags?.[0]} />
                        )}
                      </div>
                      <h2 class="mb-2 text-lg leading-snug font-semibold transition-colors group-hover:text-accent">
                        {post.data.title}
                      </h2>
                      <Datetime
                        pubDatetime={article.pubDate}
                        modDatetime={article.updatedDate}
                        timezone={post.data.timezone}
                      />
                    </a>
                  </article>
                );
              })}
            </div>
          </section>
        </RevealOnScroll>
      )
    }

    <SectionDivider />

    <!-- ART√çCULOS RECIENTES -->
    {
      remainingPosts.length > 0 && (
        <RevealOnScroll delay={100}>
          <section class="py-8">
            <h2 class="mb-6 text-xl font-semibold tracking-wide">
              Art√≠culos Recientes
            </h2>
            <ul class="grid gap-6 md:grid-cols-2 xl:grid-cols-3">
              {remainingPosts.map(data => (
                <Card variant="h3" {...data} />
              ))}
            </ul>
          </section>
        </RevealOnScroll>
      )
    }

    <SectionDivider />

    <!-- CALCULADORAS CTA -->
    <RevealOnScroll delay={200}>
      <section
        class="mb-8 rounded-xl border border-accent/20 bg-accent/5 px-6 py-6"
      >
        <h2 class="mb-1 text-lg font-semibold">üßÆ Calculadoras financieras</h2>
        <p class="mb-4 text-sm text-secondary">
          Calcula tu sueldo l√≠quido, AFP y m√°s con par√°metros econ√≥micos
          vigentes.
        </p>
        <LinkButton href={getPath("/calculadoras/")}>
          Ver calculadoras <IconArrowRight
            class="inline-block rtl:-rotate-180"
          />
        </LinkButton>
      </section>
    </RevealOnScroll>

    <!-- VER TODOS -->
    <div class="mb-10 text-center">
      <LinkButton href={getPath("/posts/")}>
        Ver todos los art√≠culos
        <IconArrowRight class="inline-block rtl:-rotate-180" />
      </LinkButton>
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline define:vars={{ homePath }}>
  document.addEventListener("astro:page-load", () => {
    sessionStorage.setItem("backUrl", homePath);
  });
</script>
