---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";
import Card from "@/components/Card.astro";
import LinkButton from "@/components/LinkButton.astro";
import getSortedPosts from "@/utils/getSortedPosts";
import IconArrowRight from "@/assets/icons/IconArrowRight.svg";
import { SITE } from "@/config";
import { getPath } from "@/utils/getPath";

const posts = await getCollection("blog");
const sortedPosts = getSortedPosts(posts);
const featuredPosts = sortedPosts.filter(({ data }) => data.featured);
const recentPosts = sortedPosts.filter(({ data }) => !data.featured);
const heroPosts = featuredPosts.slice(0, 1);
const secondaryPosts = [...featuredPosts.slice(1), ...recentPosts].slice(0, 2);
const usedSlugs = new Set([...heroPosts, ...secondaryPosts].map(p => p.id));
const remainingPosts = sortedPosts
  .filter(p => !usedSlugs.has(p.id))
  .slice(0, SITE.postPerIndex);
const homePath = getPath("/");
---

<Layout>
  <Header />
  <main id="main-content" data-layout="index" class="app-layout">
    <!-- HERO -->
    {
      heroPosts.length > 0 &&
        heroPosts.map(post => (
          <section class="border-b border-border py-8">
            <a href={getPath(`/posts/${post.id}/`)} class="group block">
              <span class="mb-3 inline-block rounded-full bg-accent/10 px-3 py-1 text-xs font-semibold tracking-widest text-accent uppercase">
                Destacado
              </span>
              <h1 class="mb-3 text-3xl leading-tight font-bold transition-colors group-hover:text-accent sm:text-4xl">
                {post.data.title}
              </h1>
              <p class="mb-4 max-w-2xl text-base leading-relaxed text-foreground/60">
                {post.data.description}
              </p>
              <span class="inline-flex items-center gap-1 text-sm font-semibold text-accent">
                Leer art√≠culo <IconArrowRight class="inline-block" />
              </span>
            </a>
          </section>
        ))
    }

    <!-- GRID SECUNDARIO -->
    {
      secondaryPosts.length > 0 && (
        <section class="grid gap-6 border-b border-border py-8 sm:grid-cols-2">
          {secondaryPosts.map(post => (
            <a
              href={getPath(`/posts/${post.id}/`)}
              class="group rounded-xl border border-border p-5 transition-colors hover:border-accent"
            >
              <h2 class="mb-2 text-lg leading-snug font-semibold transition-colors group-hover:text-accent">
                {post.data.title}
              </h2>
              <p class="text-sm leading-relaxed text-foreground/60">
                {post.data.description}
              </p>
            </a>
          ))}
        </section>
      )
    }

    <!-- ART√çCULOS RECIENTES -->
    {
      remainingPosts.length > 0 && (
        <section class="py-8">
          <h2 class="mb-6 text-xl font-semibold tracking-wide">
            Art√≠culos Recientes
          </h2>
          <ul>
            {remainingPosts.map(data => (
              <Card variant="h3" {...data} />
            ))}
          </ul>
        </section>
      )
    }

    <!-- CALCULADORAS CTA -->
    <section
      class="mb-8 rounded-xl border border-accent/20 bg-accent/5 px-6 py-6"
    >
      <h2 class="mb-1 text-lg font-semibold">üßÆ Calculadoras financieras</h2>
      <p class="mb-4 text-sm text-foreground/60">
        Calcul√° tu sueldo l√≠quido, AFP y m√°s ‚Äî actualizado 2025.
      </p>
      <LinkButton href={getPath("/calculadoras/")}>
        Ver calculadoras <IconArrowRight class="inline-block rtl:-rotate-180" />
      </LinkButton>
    </section>

    <!-- VER TODOS -->
    <div class="mb-10 text-center">
      <LinkButton href={getPath("/posts/")}>
        Ver todos los art√≠culos
        <IconArrowRight class="inline-block rtl:-rotate-180" />
      </LinkButton>
    </div>
  </main>
  <Footer />
</Layout>

<script is:inline define:vars={{ homePath }}>
  document.addEventListener("astro:page-load", () => {
    sessionStorage.setItem("backUrl", homePath);
  });
</script>
